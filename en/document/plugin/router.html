<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tag Router | Sermant</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/logo.svg">
    <meta name="description" content="A Proxyless Service Mesh Solution Based on Java Agent">
    
    <link rel="preload" href="/assets/css/0.styles.f25e8a34.css" as="style"><link rel="preload" href="/assets/js/app.0c37437b.js" as="script"><link rel="preload" href="/assets/js/3.e99918ff.js" as="script"><link rel="preload" href="/assets/js/1.4fd01240.js" as="script"><link rel="preload" href="/assets/js/43.8adf852c.js" as="script"><link rel="preload" href="/assets/js/14.4a36f0eb.js" as="script"><link rel="prefetch" href="/assets/js/10.17b9f64e.js"><link rel="prefetch" href="/assets/js/11.08dc8872.js"><link rel="prefetch" href="/assets/js/12.6595c333.js"><link rel="prefetch" href="/assets/js/13.090b752f.js"><link rel="prefetch" href="/assets/js/15.a3e8f5f5.js"><link rel="prefetch" href="/assets/js/16.5b0e382b.js"><link rel="prefetch" href="/assets/js/17.b4ad37e9.js"><link rel="prefetch" href="/assets/js/18.6b347a68.js"><link rel="prefetch" href="/assets/js/19.ece7ee39.js"><link rel="prefetch" href="/assets/js/20.398de5cf.js"><link rel="prefetch" href="/assets/js/21.9a34f77c.js"><link rel="prefetch" href="/assets/js/22.d3ca8eb9.js"><link rel="prefetch" href="/assets/js/23.0180e2f5.js"><link rel="prefetch" href="/assets/js/24.7b27df74.js"><link rel="prefetch" href="/assets/js/25.28d838e0.js"><link rel="prefetch" href="/assets/js/26.3e9fe9cd.js"><link rel="prefetch" href="/assets/js/27.00857edb.js"><link rel="prefetch" href="/assets/js/28.3cc8b547.js"><link rel="prefetch" href="/assets/js/29.aee654a9.js"><link rel="prefetch" href="/assets/js/30.53336dad.js"><link rel="prefetch" href="/assets/js/31.ff682f4e.js"><link rel="prefetch" href="/assets/js/32.928dfeb2.js"><link rel="prefetch" href="/assets/js/33.796f7d72.js"><link rel="prefetch" href="/assets/js/34.86de0d34.js"><link rel="prefetch" href="/assets/js/35.f085fe96.js"><link rel="prefetch" href="/assets/js/36.85423393.js"><link rel="prefetch" href="/assets/js/37.73790f6f.js"><link rel="prefetch" href="/assets/js/38.ad0e607b.js"><link rel="prefetch" href="/assets/js/39.306cd45b.js"><link rel="prefetch" href="/assets/js/4.31bd8acc.js"><link rel="prefetch" href="/assets/js/40.b1cdecba.js"><link rel="prefetch" href="/assets/js/41.154af7f3.js"><link rel="prefetch" href="/assets/js/42.19c76eda.js"><link rel="prefetch" href="/assets/js/44.ca125e93.js"><link rel="prefetch" href="/assets/js/45.d00e5e13.js"><link rel="prefetch" href="/assets/js/46.656ac116.js"><link rel="prefetch" href="/assets/js/47.0f563fc1.js"><link rel="prefetch" href="/assets/js/48.73b0dd59.js"><link rel="prefetch" href="/assets/js/49.e866a914.js"><link rel="prefetch" href="/assets/js/5.74dc9f02.js"><link rel="prefetch" href="/assets/js/50.f9ef55ad.js"><link rel="prefetch" href="/assets/js/51.9294f3cb.js"><link rel="prefetch" href="/assets/js/52.c0940456.js"><link rel="prefetch" href="/assets/js/53.48837652.js"><link rel="prefetch" href="/assets/js/54.10449547.js"><link rel="prefetch" href="/assets/js/55.86b41644.js"><link rel="prefetch" href="/assets/js/56.46badd63.js"><link rel="prefetch" href="/assets/js/57.a234538e.js"><link rel="prefetch" href="/assets/js/58.9e820f42.js"><link rel="prefetch" href="/assets/js/59.4295face.js"><link rel="prefetch" href="/assets/js/6.03f50aff.js"><link rel="prefetch" href="/assets/js/60.c80c12a3.js"><link rel="prefetch" href="/assets/js/61.9d7c8319.js"><link rel="prefetch" href="/assets/js/62.169732bc.js"><link rel="prefetch" href="/assets/js/63.4a6229c4.js"><link rel="prefetch" href="/assets/js/64.15fb1b32.js"><link rel="prefetch" href="/assets/js/65.3d541e31.js"><link rel="prefetch" href="/assets/js/66.4f63ad70.js"><link rel="prefetch" href="/assets/js/67.b979e9d7.js"><link rel="prefetch" href="/assets/js/68.d6fe8804.js"><link rel="prefetch" href="/assets/js/69.14ac6fc1.js"><link rel="prefetch" href="/assets/js/7.2d996cd8.js"><link rel="prefetch" href="/assets/js/70.5dd6c1da.js"><link rel="prefetch" href="/assets/js/71.cf5600f0.js"><link rel="prefetch" href="/assets/js/72.823f044e.js"><link rel="prefetch" href="/assets/js/73.72924bcd.js"><link rel="prefetch" href="/assets/js/74.c83abff9.js"><link rel="prefetch" href="/assets/js/75.6af8490f.js"><link rel="prefetch" href="/assets/js/76.64857848.js"><link rel="prefetch" href="/assets/js/77.5e0c7cd7.js"><link rel="prefetch" href="/assets/js/78.079a04d9.js"><link rel="prefetch" href="/assets/js/79.7ed73e97.js"><link rel="prefetch" href="/assets/js/8.a585d78c.js"><link rel="prefetch" href="/assets/js/80.0ad563f4.js"><link rel="prefetch" href="/assets/js/81.22b124b2.js"><link rel="prefetch" href="/assets/js/82.ccfc7614.js"><link rel="prefetch" href="/assets/js/83.acc8fea8.js"><link rel="prefetch" href="/assets/js/84.0437a766.js"><link rel="prefetch" href="/assets/js/85.dee8da6a.js"><link rel="prefetch" href="/assets/js/86.78dd43c8.js"><link rel="prefetch" href="/assets/js/87.13a0fa0b.js"><link rel="prefetch" href="/assets/js/88.8e560e3b.js"><link rel="prefetch" href="/assets/js/89.06eb6897.js"><link rel="prefetch" href="/assets/js/9.343be3f8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f25e8a34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/en/" class="home-link router-link-active"><img src="/img/sermant-logo.png" alt="Sermant" class="logo"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/huaweicloud/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/plugin/router.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/plugin/router.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/huaweicloud/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/plugin/router.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/plugin/router.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Start</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>User Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Plugin Guide</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/en/document/plugin/" aria-current="page" class="sidebar-link">Plugin</a></li><li><a href="/en/document/plugin/dynamic-config.html" class="sidebar-link">Dynamic Configuration</a></li><li><a href="/en/document/plugin/flowcontrol.html" class="sidebar-link">FlowControl</a></li><li><a href="/en/document/plugin/graceful.html" class="sidebar-link">Graceful Online/Offline</a></li><li><a href="/en/document/plugin/loadbalancer.html" class="sidebar-link">Load balancing</a></li><li><a href="/en/document/plugin/monitor.html" class="sidebar-link">Monitoring</a></li><li><a href="/en/document/plugin/router.html" aria-current="page" class="active sidebar-link">Tag Router</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/en/document/plugin/router.html#function" class="sidebar-link">Function</a></li><li class="sidebar-sub-header"><a href="/en/document/plugin/router.html#parameter-configuration" class="sidebar-link">Parameter Configuration</a></li><li class="sidebar-sub-header"><a href="/en/document/plugin/router.html#detailed-routing-rules" class="sidebar-link">Detailed Routing Rules</a></li><li class="sidebar-sub-header"><a href="/en/document/plugin/router.html#supported-versions-and-limitations" class="sidebar-link">Supported Versions and Limitations</a></li><li class="sidebar-sub-header"><a href="/en/document/plugin/router.html#operation-and-result-verification" class="sidebar-link">Operation and Result Verification</a></li></ul></li><li><a href="/en/document/plugin/register-migration.html" class="sidebar-link">Service-Registry</a></li><li><a href="/en/document/plugin/springboot-registry.html" class="sidebar-link">SpringBoot Registry</a></li><li><a href="/en/document/plugin/visibility.html" class="sidebar-link">Service visibility</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Developer Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Community Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>FAQ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tag-router"><a href="#tag-router" class="header-anchor">#</a> Tag Router</h1> <p>This document is used to introduce the usage of <a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-plugins/sermant-router" target="_blank" rel="noopener noreferrer">tag router<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="function"><a href="#function" class="header-anchor">#</a> Function</h2> <p>The tag routing plug-in implements the configuration and management of routing rules between microservices in a non-intrusive way. In the case of multiple versions and instances of microservices, the label routing plug-in can manage the routing between services by configuring routing rules to achieve lossless upgrade, application dial test and other business purposes.</p> <h2 id="parameter-configuration"><a href="#parameter-configuration" class="header-anchor">#</a> Parameter Configuration</h2> <h3 id="sermant-agent-configuration"><a href="#sermant-agent-configuration" class="header-anchor">#</a> Sermant-agent Configuration</h3> <p>The routing plugin requires service metadata (version number, other metadata) to be configured in the Sermant-agent, refer to <a href="/en/document/user-guide/sermant-agent.html#sermant-agent-parameter-configuration">Sermant-agent User Manual</a>.</p> <ul><li><p>service.meta.version: version, used to identify the current version of the microservice.</p></li> <li><p>service.meta.parameters: other metadata, used to tag the current microservice, like k1:v1,k2:v2.</p></li></ul> <h2 id="detailed-routing-rules"><a href="#detailed-routing-rules" class="header-anchor">#</a> Detailed Routing Rules</h2> <p>Router plugin based on dynamic configuration center for configuration release, configuration release can refer to <a href="/en/document/user-guide/configuration-center.html#publish-configuration">Configuration Center User's Manual</a>.</p> <p>The key value needs to be <strong>servicecomb.routeRule.${yourServiceName}</strong>, ${yourServiceName} is the microservice name (i.e. the value of spring.application.name/dubbo.application.name configuration) of the target application.</p> <p>The group needs to be configured to application level, i.e. <strong>app=${service.meta.application}&amp;environment=${service.meta.environment}</strong>, for the configuration of service.meta.application and service.meta.environment, please refer to <a href="/en/document/user-guide/sermant-agent.html#sermant-agent-parameter-configuration">Sermant-agent User Manual</a>.</p> <p>The content is the specific routing rule.</p> <h3 id="examples-of-tag-routing-rules-and-descriptions-are-as-follows"><a href="#examples-of-tag-routing-rules-and-descriptions-are-as-follows" class="header-anchor">#</a> Examples of tag routing rules and descriptions are as follows:</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">precedence</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># Priority, the higher the number, the higher the priority.</span>
  <span class="token key atrule">match</span><span class="token punctuation">:</span> <span class="token comment"># Request match rule. 0..N, not configured to indicate a match. Only one attachments/headers/args are allowed per match rule.</span>
    <span class="token key atrule">attachments</span><span class="token punctuation">:</span> <span class="token comment"># dubbo attachment matches. If it is an http header match, you need to configure it as headers.</span>
      <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token comment"># The attribute name is modified to a specific key when used. If multiple keys are configured, all key rules must match the request.</span>
        <span class="token key atrule">exact</span><span class="token punctuation">:</span> <span class="token string">'1'</span> <span class="token comment"># Configuration policy, The attribute value of key is equal to 1, detailed configuration policy refer to the configuration policy table.</span>
        <span class="token key atrule">caseInsensitive</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># false: case-insensitive (default), true: case-sensitive. When configured to false, it will be converted to uppercase uniformly for comparison.</span>
  <span class="token key atrule">route</span><span class="token punctuation">:</span> <span class="token comment"># Routing Rules</span>
    <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">20</span> <span class="token comment"># Weight</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span>
        <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.0 <span class="token comment"># Instance tagging. Instances that meet the tagging criteria are placed in this group.</span>
    <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Weight</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span>
        <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.1 <span class="token comment"># Instance tagging. Instances that meet the tagging criteria are placed in this group.</span>
<span class="token punctuation">-</span> <span class="token key atrule">precedence</span><span class="token punctuation">:</span> 1 2 <span class="token comment"># Priority, the higher the number, the higher the priority.</span>
  <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">20</span> <span class="token comment"># Weight</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> red <span class="token comment"># Instance tagging. Instances that meet the tagging criteria are placed in this group.</span>
    <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Weight</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> green <span class="token comment"># Instance tagging. Instances that meet the tagging criteria are placed in this group.</span>
</code></pre></div><table><thead><tr><th style="text-align:center;">Parameter key</th> <th style="text-align:center;">Description</th> <th style="text-align:center;">Default value</th> <th style="text-align:center;">Required</th></tr></thead> <tbody><tr><td style="text-align:center;">priority</td> <td style="text-align:center;">priority, the higher the number, the higher the priority.</td> <td style="text-align:center;">Empty</td> <td style="text-align:center;">yes</td></tr> <tr><td style="text-align:center;">match</td> <td style="text-align:center;">Matching rules, support attachments (attachments parameter of the dubbo application)/headers (request header)</td> <td style="text-align:center;">Empty</td> <td style="text-align:center;">no</td></tr> <tr><td style="text-align:center;">exact</td> <td style="text-align:center;">Configuration policy. For detailed configuration policy, refer to <a href="#configuration-policy-table">Configuration Policy Table</a></td> <td style="text-align:center;">Empty</td> <td style="text-align:center;">no</td></tr> <tr><td style="text-align:center;">route</td> <td style="text-align:center;">routing rule, Including weight configuration and label information configuration</td> <td style="text-align:center;">Empty</td> <td style="text-align:center;">yes</td></tr> <tr><td style="text-align:center;">weight</td> <td style="text-align:center;">weight value</td> <td style="text-align:center;">Empty</td> <td style="text-align:center;">yes</td></tr> <tr><td style="text-align:center;">tags</td> <td style="text-align:center;">Tag information. The instances that meet the tag conditions are placed in this group</td> <td style="text-align:center;">Empty</td> <td style="text-align:center;">yes</td></tr></tbody></table> <p><strong>Label routing rule interpretation</strong></p> <ul><li>80% of the requests with the id attribute value of 1 in the attachments information will be routed to the service instance with the version number of 1.0.1, and 20% will be routed to the service instance with the version number of 1.0.0. 80% of other requests will be routed to the service instance with the group name green, and 20% will be routed to the service instance with the group name red.</li></ul> <blockquote><p>Note: When adding a new configuration, please remove the comment, otherwise it will cause the addition to fail.</p></blockquote> <h3 id="configuration-policy-table"><a href="#configuration-policy-table" class="header-anchor">#</a> Configuration Policy Table</h3> <table><thead><tr><th style="text-align:center;">Strategy Name</th> <th style="text-align:center;">Strategy Value</th> <th style="text-align:center;">Matching Rules</th></tr></thead> <tbody><tr><td style="text-align:center;">Exact Match</td> <td style="text-align:center;">exact</td> <td style="text-align:center;">The parameter value is equal to the configured value</td></tr> <tr><td style="text-align:center;">Regex Match</td> <td style="text-align:center;">regex</td> <td style="text-align:center;">Parameter values match regex expressions, Since some regex expressions (such as \w and \W, etc.) are case-sensitive, please choose caseInsensitive (case-sensitive or not) carefully when using regex match</td></tr> <tr><td style="text-align:center;">Not Equal Match</td> <td style="text-align:center;">noEqu</td> <td style="text-align:center;">The parameter value is not equal to the configuration value</td></tr> <tr><td style="text-align:center;">Not Less Match</td> <td style="text-align:center;">noLess</td> <td style="text-align:center;">The parameter value is not less than the configured value</td></tr> <tr><td style="text-align:center;">Not Greater Match</td> <td style="text-align:center;">noGreater</td> <td style="text-align:center;">The parameter value is not greater than the configured value</td></tr> <tr><td style="text-align:center;">Greater Match</td> <td style="text-align:center;">greater</td> <td style="text-align:center;">The parameter value is greater than the configured value</td></tr> <tr><td style="text-align:center;">Less Match</td> <td style="text-align:center;">less</td> <td style="text-align:center;">The parameter value is less than the configured value</td></tr></tbody></table> <h2 id="supported-versions-and-limitations"><a href="#supported-versions-and-limitations" class="header-anchor">#</a> Supported Versions and Limitations</h2> <p>Framework Supported:</p> <ul><li><p>SpringCloud Edgware.SR2 - 2021.0.0</p></li> <li><p>Dubbo 2.6.x - 2.7.x</p></li></ul> <p>Limitations:</p> <ul><li>Asynchronous invocation is not supported</li></ul> <h2 id="operation-and-result-verification"><a href="#operation-and-result-verification" class="header-anchor">#</a> Operation and Result Verification</h2> <p>Take the Spring Cloud scenario as an example to demonstrate the use of label routing plug-ins.</p> <h3 id="preparations"><a href="#preparations" class="header-anchor">#</a> Preparations</h3> <ul><li><p><a href="https://github.com/huaweicloud/Sermant/releases" target="_blank" rel="noopener noreferrer">Download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>/Compile the sermant package</p></li> <li><p><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/router-demo/spring-cloud-router-demo" target="_blank" rel="noopener noreferrer">Download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> spring-cloud-router-demo source code</p></li> <li><p><a href="https://github.com/apache/servicecomb-service-center" target="_blank" rel="noopener noreferrer">Download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ServiceComb, and start</p></li> <li><p><a href="https://zookeeper.apache.org/releases.html#download" target="_blank" rel="noopener noreferrer">Download<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Zookeeper, and start</p></li></ul> <h3 id="step-1-compile-and-package-the-spring-cloud-router-demo-application"><a href="#step-1-compile-and-package-the-spring-cloud-router-demo-application" class="header-anchor">#</a> Step 1: Compile and package the spring-cloud-router-demo application</h3> <p>Execute the following command in the <code>${path}/Sermant-examples/router-demo/spring-cloud-router-demo</code> directory:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># windows</span>
mvn clean package

<span class="token comment"># mac, linux</span>
mvn clean package
</code></pre></div><p>After successful packaging, you can get <code>spring-cloud-router-consumer.jar</code> in <code>${path}/Sermant-examples/router-demo/spring-cloud-router-demo/spring-cloud-router-consumer/target</code> , get <code>spring-cloud-router-provider.jar</code> in <code>${path}/Sermant-examples/router-demo/spring-cloud-router-demo/spring-cloud-router-provider/target</code> , get <code>spring-cloud-router-zuul.jar</code> in <code>${path}/Sermant-examples/router-demo/spring-cloud-router-demo/spring-cloud-router-zuul/target</code>.</p> <blockquote><p>Note: path is the path where the spring-cloud-router-demo application is downloaded.</p></blockquote> <h3 id="step-2-deploying-the-applications"><a href="#step-2-deploying-the-applications" class="header-anchor">#</a> Step 2: Deploying the applications</h3> <p>(1) Start the zuul gateway</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># windows</span>
<span class="token function">java</span> <span class="token parameter variable">-Dservicecomb_service_enableSpringRegister</span><span class="token operator">=</span>true -javaagent:<span class="token variable">${path}</span><span class="token punctuation">\</span>sermant-agent-x.x.x<span class="token punctuation">\</span>agent<span class="token punctuation">\</span>sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> spring-cloud-router-zuul.jar

<span class="token comment"># mac, linux</span>
<span class="token function">java</span> <span class="token parameter variable">-Dservicecomb_service_enableSpringRegister</span><span class="token operator">=</span>true -javaagent:<span class="token variable">${path}</span>/sermant-agent-x.x.x/agent/sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> spring-cloud-router-zuul.jar
</code></pre></div><p>(2) Start the consumer</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># windows</span>
<span class="token function">java</span> <span class="token parameter variable">-Dservicecomb_service_enableSpringRegister</span><span class="token operator">=</span>true -javaagent:<span class="token variable">${path}</span><span class="token punctuation">\</span>sermant-agent-x.x.x<span class="token punctuation">\</span>agent<span class="token punctuation">\</span>sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> spring-cloud-router-consumer.jar

<span class="token comment"># mac, linux</span>
<span class="token function">java</span> <span class="token parameter variable">-Dservicecomb_service_enableSpringRegister</span><span class="token operator">=</span>true -javaagent:<span class="token variable">${path}</span>/sermant-agent-x.x.x/agent/sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> spring-cloud-router-consumer.jar
</code></pre></div><p>(3) Start the provider</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># windows</span>
<span class="token function">java</span> <span class="token parameter variable">-Dservicecomb_service_enableSpringRegister</span><span class="token operator">=</span>true -javaagent:<span class="token variable">${path}</span><span class="token punctuation">\</span>sermant-agent-x.x.x<span class="token punctuation">\</span>agent<span class="token punctuation">\</span>sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> spring-cloud-router-provider.jar

<span class="token comment"># mac, linux</span>
<span class="token function">java</span> <span class="token parameter variable">-Dservicecomb_service_enableSpringRegister</span><span class="token operator">=</span>true -javaagent:<span class="token variable">${path}</span>/sermant-agent-x.x.x/agent/sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> spring-cloud-router-provider.jar
</code></pre></div><p>(4) Start the provider with tag (version is 1.0.1, tag is group:gray.)</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># windows</span>
<span class="token function">java</span> <span class="token parameter variable">-Dservicecomb_service_enableSpringRegister</span><span class="token operator">=</span>true <span class="token parameter variable">-Dservice_meta_version</span><span class="token operator">=</span><span class="token number">1.0</span>.1 <span class="token parameter variable">-Dservice_meta_parameters</span><span class="token operator">=</span>group:gray <span class="token parameter variable">-Dserver.port</span><span class="token operator">=</span><span class="token number">8163</span> -javaagent:<span class="token variable">${path}</span><span class="token punctuation">\</span>sermant-agent-x.x.x<span class="token punctuation">\</span>agent<span class="token punctuation">\</span>sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> spring-cloud-router-provider.jar

<span class="token comment"># mac, linux</span>
<span class="token function">java</span> <span class="token parameter variable">-Dservicecomb_service_enableSpringRegister</span><span class="token operator">=</span>true <span class="token parameter variable">-Dservice_meta_version</span><span class="token operator">=</span><span class="token number">1.0</span>.1 <span class="token parameter variable">-Dservice_meta_parameters</span><span class="token operator">=</span>group:gray <span class="token parameter variable">-Dserver.port</span><span class="token operator">=</span><span class="token number">8163</span> -javaagent:<span class="token variable">${path}</span>/sermant-agent-x.x.x/agent/sermant-agent.jar<span class="token operator">=</span>appName<span class="token operator">=</span>default <span class="token parameter variable">-jar</span> spring-cloud-router-provider.jar
</code></pre></div><blockquote><p><strong>Description</strong>:
where path needs to be replaced with the actual installation path of Sermant.
x.x.x represents a Sermant version number.</p></blockquote> <h3 id="step-3-view-service-registration"><a href="#step-3-view-service-registration" class="header-anchor">#</a> Step 3: View service registration</h3> <p>Login <a href="http://127.0.0.1:30103/" target="_blank" rel="noopener noreferrer">ServiceComb<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> In the background, check whether the service is registered successfully.</p> <div class="el-image"><div class="el-image__placeholder"></div><!----></div> <h3 id="step-4-publish-configuration"><a href="#step-4-publish-configuration" class="header-anchor">#</a> Step 4: Publish configuration</h3> <p>Configure routing rules. Refer to the <a href="/en/document/user-guide/configuration-center.html#publish-configuration">Dynamic Configuration Center User Manual</a> for configuration publishing.</p> <p>The key value is <strong>servicecomb.routeRule.spring-cloud-router-provider</strong>, the group is <strong>app=default&amp;environment=</strong>, and the content is the specific routing rule, as follows.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">precedence</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token key atrule">headers</span><span class="token punctuation">:</span>
      <span class="token key atrule">id</span><span class="token punctuation">:</span>
        <span class="token key atrule">exact</span><span class="token punctuation">:</span> <span class="token string">'1'</span>
        <span class="token key atrule">caseInsensitive</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> gray
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token punctuation">-</span> <span class="token key atrule">precedence</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token key atrule">headers</span><span class="token punctuation">:</span>
      <span class="token key atrule">id</span><span class="token punctuation">:</span>
        <span class="token key atrule">exact</span><span class="token punctuation">:</span> <span class="token string">'2'</span>
        <span class="token key atrule">caseInsensitive</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span>
        <span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
</code></pre></div><p><strong>Label routing rule interpretation</strong></p> <ul><li>The request with the id attribute value of 1 in the request header information will be routed to the service instance with the group name of gray, and the request with the id attribute value of 2 will be routed to the service instance with the version number of 1.0.1.</li></ul> <p>Take Zookeeper as an example, and use the command line tools provided by Zookeeper for configuration publishing.</p> <ol><li>Execute the following command in the <code>${path}/bin/</code> directory to create the node <code>/app=default&amp;environment=</code></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># linux mac</span>
./zkCli.sh <span class="token parameter variable">-server</span> localhost:2181 create /app<span class="token operator">=</span>default<span class="token operator">&amp;</span><span class="token assign-left variable">environment</span><span class="token operator">=</span>

<span class="token comment"># windows</span>
zkCli.cmd <span class="token parameter variable">-server</span> localhost:2181 create /app<span class="token operator">=</span>default<span class="token operator">&amp;</span><span class="token assign-left variable">environment</span><span class="token operator">=</span>
</code></pre></div><blockquote><p>Note: <code>${path}</code> is the installation directory of zookeeper</p></blockquote> <ol start="2"><li>Execute the following command in the <code>${path}/bin/</code> directory to create the node <code>/app=default&amp;environment=/servicecomb.routeRule.spring-cloud-router-provider</code> and set the data.</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># linux mac</span>
./zkCli.sh <span class="token parameter variable">-server</span> localhost:2181 create /app<span class="token operator">=</span>default<span class="token operator">&amp;</span><span class="token assign-left variable">environment</span><span class="token operator">=</span>/servicecomb.routeRule.spring-cloud-router-provider <span class="token string">&quot;---
- precedence: 1
  match:
    headers:
      id:
        exact: '1'
        caseInsensitive: false
  route:
    - tags:
        group: gray
      weight: 100
- precedence: 2
  match:
    headers:
      id:
        exact: '2'
        caseInsensitive: false
  route:
    - tags:
        version: 1.0.1
      weight: 100&quot;</span>

<span class="token comment"># windows</span>
zkCli.cmd <span class="token parameter variable">-server</span> localhost:2181 create /app<span class="token operator">=</span>default<span class="token operator">&amp;</span><span class="token assign-left variable">environment</span><span class="token operator">=</span>/servicecomb.routeRule.spring-cloud-router-provider <span class="token string">&quot;---
- precedence: 1
  match:
    headers:
      id:
        exact: '1'
        caseInsensitive: false
  route:
    - tags:
        group: gray
      weight: 100
- precedence: 2
  match:
    headers:
      id:
        exact: '2'
        caseInsensitive: false
  route:
    - tags:
        version: 1.0.1
      weight: 100&quot;</span>
</code></pre></div><h3 id="verification"><a href="#verification" class="header-anchor">#</a> Verification</h3> <div class="el-image"><div class="el-image__placeholder"></div><!----></div> <p>After starting the above 4 applications and configuring the routing rules correctly, when accessing <code>http://127.0.0.1:8170/consumer/hello/rest</code> through the http client tool, we can find that when the request header is id: 1 or id: 2, it will be routed to the provider of version 1.0.1, and when the above conditions are not met When the above condition is not met, it will visit the provider with version 1.0.0.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/22/2023, 10:29:57 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/en/document/plugin/monitor.html" class="prev">
        Monitoring
      </a></span> <span class="next"><a href="/en/document/plugin/register-migration.html">
        Service-Registry
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0c37437b.js" defer></script><script src="/assets/js/3.e99918ff.js" defer></script><script src="/assets/js/1.4fd01240.js" defer></script><script src="/assets/js/43.8adf852c.js" defer></script><script src="/assets/js/14.4a36f0eb.js" defer></script>
  </body>
</html>
