<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Sermant-injector User Manual | Sermant</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/logo.svg">
    <meta name="description" content="A Proxyless Service Mesh Solution Based on Java Agent">
    
    <link rel="preload" href="/assets/css/0.styles.934e6042.css" as="style"><link rel="preload" href="/assets/js/app.56245a25.js" as="script"><link rel="preload" href="/assets/js/3.c22b673d.js" as="script"><link rel="preload" href="/assets/js/1.9e8b067b.js" as="script"><link rel="preload" href="/assets/js/48.6f183f8c.js" as="script"><link rel="prefetch" href="/assets/js/10.ca8549df.js"><link rel="prefetch" href="/assets/js/11.6a8571e0.js"><link rel="prefetch" href="/assets/js/12.3caa9ab5.js"><link rel="prefetch" href="/assets/js/13.b1f0a423.js"><link rel="prefetch" href="/assets/js/14.7039f4a7.js"><link rel="prefetch" href="/assets/js/15.36703cc8.js"><link rel="prefetch" href="/assets/js/16.804e91c8.js"><link rel="prefetch" href="/assets/js/17.0f65b007.js"><link rel="prefetch" href="/assets/js/18.92d1be28.js"><link rel="prefetch" href="/assets/js/19.ce355d42.js"><link rel="prefetch" href="/assets/js/20.89bea0c7.js"><link rel="prefetch" href="/assets/js/21.945c9d2a.js"><link rel="prefetch" href="/assets/js/22.92e167cf.js"><link rel="prefetch" href="/assets/js/23.f67f4b5e.js"><link rel="prefetch" href="/assets/js/24.69a732d8.js"><link rel="prefetch" href="/assets/js/25.4876205d.js"><link rel="prefetch" href="/assets/js/26.6739bd0c.js"><link rel="prefetch" href="/assets/js/27.8e5c7da7.js"><link rel="prefetch" href="/assets/js/28.bfac4c9e.js"><link rel="prefetch" href="/assets/js/29.53aabd90.js"><link rel="prefetch" href="/assets/js/30.a9d9a2a9.js"><link rel="prefetch" href="/assets/js/31.60ffcf24.js"><link rel="prefetch" href="/assets/js/32.3173505b.js"><link rel="prefetch" href="/assets/js/33.545c5274.js"><link rel="prefetch" href="/assets/js/34.00264371.js"><link rel="prefetch" href="/assets/js/35.276e3817.js"><link rel="prefetch" href="/assets/js/36.b0d41169.js"><link rel="prefetch" href="/assets/js/37.2fad2a48.js"><link rel="prefetch" href="/assets/js/38.0aa576a4.js"><link rel="prefetch" href="/assets/js/39.4757bdce.js"><link rel="prefetch" href="/assets/js/4.94f1233f.js"><link rel="prefetch" href="/assets/js/40.416a30c0.js"><link rel="prefetch" href="/assets/js/41.fee59cd9.js"><link rel="prefetch" href="/assets/js/42.d0f88052.js"><link rel="prefetch" href="/assets/js/43.2be6fc39.js"><link rel="prefetch" href="/assets/js/44.16c1ffcf.js"><link rel="prefetch" href="/assets/js/45.9c66aab6.js"><link rel="prefetch" href="/assets/js/46.0c089932.js"><link rel="prefetch" href="/assets/js/47.6b16ba66.js"><link rel="prefetch" href="/assets/js/49.8236e4a0.js"><link rel="prefetch" href="/assets/js/5.05c6b3e9.js"><link rel="prefetch" href="/assets/js/50.91ee7d0a.js"><link rel="prefetch" href="/assets/js/51.3890a4c6.js"><link rel="prefetch" href="/assets/js/52.76c23ee8.js"><link rel="prefetch" href="/assets/js/53.3b3b4ad4.js"><link rel="prefetch" href="/assets/js/54.8c695126.js"><link rel="prefetch" href="/assets/js/55.24d58397.js"><link rel="prefetch" href="/assets/js/56.a73657ef.js"><link rel="prefetch" href="/assets/js/57.4b02d6af.js"><link rel="prefetch" href="/assets/js/58.08717c67.js"><link rel="prefetch" href="/assets/js/59.e6514139.js"><link rel="prefetch" href="/assets/js/6.d82aff6e.js"><link rel="prefetch" href="/assets/js/60.5410266f.js"><link rel="prefetch" href="/assets/js/61.59e38702.js"><link rel="prefetch" href="/assets/js/62.96273134.js"><link rel="prefetch" href="/assets/js/63.807a4412.js"><link rel="prefetch" href="/assets/js/64.fd39dc04.js"><link rel="prefetch" href="/assets/js/65.afef1e74.js"><link rel="prefetch" href="/assets/js/66.3a7aeeab.js"><link rel="prefetch" href="/assets/js/67.42b5b39d.js"><link rel="prefetch" href="/assets/js/68.dab77e43.js"><link rel="prefetch" href="/assets/js/69.59b843c2.js"><link rel="prefetch" href="/assets/js/7.0aa4fbf2.js"><link rel="prefetch" href="/assets/js/70.ea2db599.js"><link rel="prefetch" href="/assets/js/71.dd9084fc.js"><link rel="prefetch" href="/assets/js/72.4828d1d6.js"><link rel="prefetch" href="/assets/js/73.b644410d.js"><link rel="prefetch" href="/assets/js/74.7626c55a.js"><link rel="prefetch" href="/assets/js/75.7fb65875.js"><link rel="prefetch" href="/assets/js/76.899c626b.js"><link rel="prefetch" href="/assets/js/77.90d41e21.js"><link rel="prefetch" href="/assets/js/78.edaa0b7b.js"><link rel="prefetch" href="/assets/js/79.e9e1e72a.js"><link rel="prefetch" href="/assets/js/8.fe2e589f.js"><link rel="prefetch" href="/assets/js/80.b2cde3fe.js"><link rel="prefetch" href="/assets/js/81.90984771.js"><link rel="prefetch" href="/assets/js/82.ea554216.js"><link rel="prefetch" href="/assets/js/83.0e507f62.js"><link rel="prefetch" href="/assets/js/84.5306af9d.js"><link rel="prefetch" href="/assets/js/85.57b25843.js"><link rel="prefetch" href="/assets/js/86.3aefe1fd.js"><link rel="prefetch" href="/assets/js/87.cc73ef62.js"><link rel="prefetch" href="/assets/js/88.f36833ec.js"><link rel="prefetch" href="/assets/js/89.73f38fbd.js"><link rel="prefetch" href="/assets/js/9.623da9fe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.934e6042.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/en/" class="home-link router-link-active"><img src="/img/sermant-logo.png" alt="Sermant" class="logo"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/huaweicloud/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/user-guide/injector.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/user-guide/injector.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/en/document/" class="nav-link">
  Document
</a></div><div class="nav-item"><a href="/en/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://github.com/huaweicloud/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Languages" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Languages" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/user-guide/injector.html" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/user-guide/injector.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Start</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>User Guide</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/en/document/user-guide/" aria-current="page" class="sidebar-link">Introduction to the use of Sermant</a></li><li><a href="/en/document/user-guide/sermant-agent.html" class="sidebar-link">Sermant-agent User Manual</a></li><li><a href="/en/document/user-guide/backend.html" class="sidebar-link">Backend User Manual</a></li><li><a href="/en/document/user-guide/configuration-center.html" class="sidebar-link">Dynamic Configuration Center User Manual</a></li><li><a href="/en/document/user-guide/injector.html" aria-current="page" class="active sidebar-link">Sermant-injector User Manual</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/en/document/user-guide/injector.html#parameter-configuration" class="sidebar-link">Parameter Configuration</a></li><li class="sidebar-sub-header"><a href="/en/document/user-guide/injector.html#version-supported" class="sidebar-link">Version Supported</a></li><li class="sidebar-sub-header"><a href="/en/document/user-guide/injector.html#startup-and-result-validation" class="sidebar-link">Startup and Result Validation</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Plugin Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Developer Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Community Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>FAQ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="sermant-injector-user-manual"><a href="#sermant-injector-user-manual" class="header-anchor">#</a> Sermant-injector User Manual</h1> <p>Sermant-injector is based on the <strong>Kubernetes Admission Controllers.</strong> The admission controller is located in the K8s API Server and is able to intercept requests to the API Server to complete operations such as authentication, authorization, and mutation. This article introduces how to use the sermant-injector component to realize the rapid deployment of the host application to automatically mount the sermant-agent package in the k8s environment.</p> <p>Sermant-injector is a MutatingAdmissionWebhook that can intercept and modify requests before creating container resources. After sermant-injector is deployed on K8s, just add <code>sermant-injection:Enabled</code> to the YAML file of the host application deployment configuration at the <code>spec &gt; Template &gt; metadata&gt; labels</code> ' then the host application can automatically mount the sermant-agent package. Additionally, sermant-injector supports configuring environment variables via <code>annotations</code>. How the deployed applications can automatically mount Sermant and configure environment variables via <code>annotations</code> is described in [Deploy Host Application](# deploy-host-application) below.</p> <h2 id="parameter-configuration"><a href="#parameter-configuration" class="header-anchor">#</a> Parameter Configuration</h2> <h3 id="parameter-configuration-for-sermant-injector"><a href="#parameter-configuration-for-sermant-injector" class="header-anchor">#</a> Parameter Configuration for sermant-injector</h3> <p>This project adopts  Helm for Kubernetes package management. The parameters for deploying sermant-injector are set in <a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-injector/deployment/release/injector/values.yaml" target="_blank" rel="noopener noreferrer">sermant-injector/deployment/release/values.yaml<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">namespace</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default

<span class="token key atrule">injector</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span>
    <span class="token key atrule">addr</span><span class="token punctuation">:</span>
    <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">pullSecrets</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>secret

<span class="token key atrule">agent</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span>
    <span class="token key atrule">addr</span><span class="token punctuation">:</span>
    <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent

<span class="token key atrule">config</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ZOOKEEPER
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">30110</span>
<span class="token key atrule">registry</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">30100</span>

<span class="token key atrule">configMap</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>default<span class="token punctuation">]</span>
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
</code></pre></div><p>The parameters are described as follows:</p> <table><thead><tr><th><span style="display:inline-block;width:100px;">Primary Parameter Key</span></th> <th><span style="display:inline-block;width:120px;">Second Parameter Key</span></th> <th><span style="display:inline-block;width:100px;">Third Parameter Key</span></th> <th>Description</th> <th><span style="display:inline-block;width:80px;">Required</span></th></tr></thead> <tbody><tr><td>namespace</td> <td>name</td> <td>-</td> <td>The namespace where the sermant-injector resides.</td> <td>True</td></tr> <tr><td>injector</td> <td>replicas</td> <td>-</td> <td>Number of deployed sermant-injector instances.</td> <td>True</td></tr> <tr><td></td> <td>image</td> <td>addr</td> <td>The mirror address of sermant-injector.</td> <td>True</td></tr> <tr><td></td> <td></td> <td>pullPolicy</td> <td>Sermant-injector image pull strategy: Always(always pull), IfNotPresent(default value, use local mirror if exists), Never(only use local mirror and never pull).</td> <td>True</td></tr> <tr><td></td> <td></td> <td>pullSecrets</td> <td>Pull secrets. The default key is default-secret and you can change it on command.</td> <td>True</td></tr> <tr><td>agent</td> <td>image</td> <td>addr</td> <td>The mirror address of sermant-agent.</td> <td>True</td></tr> <tr><td></td> <td></td> <td>pullPolicy</td> <td>Sermant-agent image pull strategy: Always(always pull), IfNotPresent(default value, use local mirror if exists), Never(only use local mirror and never pull).</td> <td>True</td></tr> <tr><td>config</td> <td>type</td> <td>-</td> <td>Configuration center type of sermant-agent: Currently two types are supported, ZOOKEEPER and KIE.</td> <td>True</td></tr> <tr><td></td> <td>endpoints</td> <td>-</td> <td>Configuration center address of sermant-agent.</td> <td>True</td></tr> <tr><td>registry</td> <td>endpoints</td> <td>-</td> <td>Registration center address of sermant-agent.</td> <td>True</td></tr> <tr><td>configMap</td> <td>enabled</td> <td>-</td> <td>Common environment variable configuration switch. The default value is false. Set it to true if you want to config common environment variables.</td> <td>True</td></tr> <tr><td></td> <td>namespaces</td> <td>-</td> <td>The namespaces to be injected with configMap which must be the same as that of the service application.</td> <td>True</td></tr> <tr><td></td> <td>env</td> <td>custom key1</td> <td>You can configure custom value1.</td> <td>False</td></tr> <tr><td></td> <td></td> <td>custom key2</td> <td>You can configure custom value2.</td> <td>False</td></tr></tbody></table> <p>**Public environment variables configuration: **</p> <p>Sermant-injector supports configuring custom environment variables for the host application in pod. Just modifying the content of the <code>configMap.env</code> in <code>sermant-injector/deployment/release/injector/values.yaml</code>. The prerequisite is that <code>configMap.enabled</code> is set to <code>true</code>, and <code>configMap.namespace</code> is configured correctly. Common environment variables can be configured as follows (kv form) :</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">configMap</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>default<span class="token punctuation">,</span> test<span class="token punctuation">]</span>
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
  	<span class="token key atrule">TEST_ENV1</span><span class="token punctuation">:</span> abc
  	<span class="token key atrule">TEST_ENV2</span><span class="token punctuation">:</span> <span class="token number">123456</span>
</code></pre></div><p>For example, during the use of Sermant, certain configurations are common to all pods in the current k8s cluster, such as ip and port of the <strong>Backend</strong>. You can configure it here:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">configMap</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>default<span class="token punctuation">]</span>	
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
  	<span class="token key atrule">backend.nettyIp</span><span class="token punctuation">:</span> 127.0.0.1
  	<span class="token key atrule">backend.nettyPort</span><span class="token punctuation">:</span> <span class="token number">8900</span>
</code></pre></div><p>All sermants in pods of default namespace are connected to the <strong>Backend</strong>.</p> <p><strong>Note</strong> : The priority of environment variables configured <code>configMap</code>  is lower than that of <code>env</code> in yaml of host application. Because <code>config.type</code>, <code>config.endpoints</code>, and <code>registry.endpoints</code> are essentially <code>env</code> loaded environment variables, they also take precedence over the corresponding sermant environment variables configured with <code>configMap</code>.</p> <h3 id="parameter-configuration-for-mirror-scripts"><a href="#parameter-configuration-for-mirror-scripts" class="header-anchor">#</a> Parameter Configuration for mirror scripts</h3> <p><strong><a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-injector/images/sermant-agent/build-sermant-image.sh" target="_blank" rel="noopener noreferrer">build-sermant-image.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></p> <table><thead><tr><th>Parameters</th> <th>Description</th> <th>Required</th></tr></thead> <tbody><tr><td>sermantVersion</td> <td>Version of sermant-agent-x.x.x.tar.gz</td> <td>True</td></tr> <tr><td>imageName</td> <td>Image name of sermant-agent mirror</td> <td>True</td></tr> <tr><td>imageVersion</td> <td>Image version of sermant-agent mirror</td> <td>True</td></tr></tbody></table> <p><strong><a href="https://github.com/huaweicloud/Sermant/blob/develop/sermant-injector/images/injector/build-injector-image.sh" target="_blank" rel="noopener noreferrer">build-injector-image.sh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></p> <table><thead><tr><th>Parameters</th> <th>Description</th> <th>Required</th></tr></thead> <tbody><tr><td>imageName</td> <td>Image name of sermant-injector mirror</td> <td>True</td></tr> <tr><td>imageVersion</td> <td>Image version of sermant-injector mirror</td> <td>True</td></tr></tbody></table> <h2 id="version-supported"><a href="#version-supported" class="header-anchor">#</a> Version Supported</h2> <p>Sermant-injector currently supports Kubernetes 1.15+ and deploys with Helm v3 for Kubernetes package management.</p> <ul><li><p><a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes 1.15+<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://helm.sh/" target="_blank" rel="noopener noreferrer">Helm v3.1+<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul> <h2 id="startup-and-result-validation"><a href="#startup-and-result-validation" class="header-anchor">#</a> Startup and Result Validation</h2> <p>Before deploying <strong>sermant-injector</strong>, you need to build the <strong>sermant-agent</strong> image and the <strong>sermant-injector</strong> image.</p> <h3 id="build-image-of-sermant-agent"><a href="#build-image-of-sermant-agent" class="header-anchor">#</a> Build Image of Sermant-agent</h3> <h4 id="prepare-sermant-agent-package"><a href="#prepare-sermant-agent-package" class="header-anchor">#</a> Prepare Sermant-agent package</h4> <p>Click <a href="https://github.com/huaweicloud/Sermant/releases" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to download latest release package <code>sermant-agent-x.x.x.tar.gz</code> or you can package sermant yourself.</p> <h4 id="build-image"><a href="#build-image" class="header-anchor">#</a> Build Image</h4> <p>Modify the values of <code>sermantVersion</code>, <code>imageName</code> and <code>imageVerison</code> in the <code>build-sermant-image.sh</code> under <code>images/sermant-agent</code> folder.</p> <p>Move <code>build-sermant-image.sh</code> and <code>Sermant.dockerfile</code> to the same directory as the release package <code>sermant-agent-xxx.tar.gz</code> in one of K8s nodes. Run <code>build-sermant-image.sh</code> to build the sermant-agent image.</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sh</span> build-sermant-image.sh
</code></pre></div><p>To push the image to the image repository, run the <code>docker push ${imageName}:{imageVerison}</code> command.</p> <h3 id="build-image-of-sermant-injector"><a href="#build-image-of-sermant-injector" class="header-anchor">#</a> Build Image of Sermant-injector</h3> <h4 id="package-sermant-injector"><a href="#package-sermant-injector" class="header-anchor">#</a> Package Sermant-injector</h4> <p>Execute the <code>mvn clean package</code> command to generate the <code>sermant-injector.jar</code> file in the directory of sermant-injector project.</p> <h4 id="build-image-2"><a href="#build-image-2" class="header-anchor">#</a> Build Image</h4> <p>Modify the values of <code>imageName</code> and <code>imageVerison</code> in the <code>build-injector-image.sh</code> script under <code>images/injector</code> folder.</p> <p>Move <code>build-injector-image.sh</code>, <code>start.sh</code> and <code>Injector.Dockerfile</code> to the same directory as the package <code>sermant-injector.jar</code>. Run <code>build-injector-image.sh</code> to create the sermant-injector image.</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sh</span> build-injector-image.sh
</code></pre></div><p>To push the image to the image repository, run the <code>docker push ${imageName}:{imageVerison}</code> command.</p> <h3 id="deploy-workload-of-sermant-injector"><a href="#deploy-workload-of-sermant-injector" class="header-anchor">#</a> Deploy Workload of Sermant-injector</h3> <p>Before the host application can be containerized, the workload of sermant-injector needs to be deployed. This project adopts Helm for Kubernetes package management and uses Chart template in<code>injector</code> under <code>deploment/release</code>.</p> <p>Modify the template variable in <code>values.yaml</code> according to the actual environment. Once this is done, execute <code>helm install</code> to deploy the sermant-injector workload in K8s:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>helm <span class="token function">install</span> sermant-injector <span class="token punctuation">..</span>/injector
</code></pre></div><p>Check that the status of the deployed pod of sermant-injector is running.</p> <p>At this point, the environment configuration of the host application before deployment is complete.</p> <h3 id="deploy-host-application"><a href="#deploy-host-application" class="header-anchor">#</a> Deploy Host Application</h3> <p><strong>Mount Sermant Automatically</strong></p> <p>After the deployment of above sermant-injector, developers should write YAML file to deploy K8s Deployment resources according to the actual application. Simply add <code>sermant-injection: enabled</code> at the <code>spec &gt; Template &gt; Metadata &gt; Labels</code> to automatically mount the sermant-agent. (If you do not want to mount it later, just delete it and restart the application)</p> <p><strong>Configure Environment Variables via Annotations</strong></p> <p>If you want to configure custom environment variables in K8s Deployment, simply add the corresponding key-value pair in the <code>spec &gt; template &gt; metadata&gt; annotations</code>. For details about the configuration, see the following example.</p> <p>Take <code>env.sermant.io/key1: &quot;value1&quot;</code> as an example, the configuration rules are: <code>env.sermant.io/</code> is the standard prefix for configuring environment variables through <code>annotations</code>, <code>key1</code> is the name of a custom environment variable that users configure on demand, and <code>value1</code> is the value of a custom environment variable that users configure on demand.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>test
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>test
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>test
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>test
        <span class="token key atrule">sermant-injection</span><span class="token punctuation">:</span> enabled
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">env.sermant.io/key1</span><span class="token punctuation">:</span> <span class="token string">&quot;value1&quot;</span>
        <span class="token key atrule">env.sermant.io/key2</span><span class="token punctuation">:</span> <span class="token string">&quot;value2&quot;</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> image
        <span class="token comment"># Please replace it with own image</span>
        <span class="token key atrule">image</span><span class="token punctuation">:</span> image<span class="token punctuation">:</span>1.0.0
        <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>
</code></pre></div><p>If the pod cannot be created, check that the sermant-injector is deployed correctly and that the sermant-agent image is built correctly.</p> <h3 id="verification"><a href="#verification" class="header-anchor">#</a> Verification</h3> <p>Once the pod is created, execute the following command, where <code>${pod_name}</code> is the pod name of host application.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get po/<span class="token variable">${pod_name}</span> <span class="token parameter variable">-o</span> yaml
</code></pre></div><ol><li><p>Check if the output contains the environment variable whose name is <code>JAVA_TOOL_OPTIONS</code>and value is <code>-javaagent:/home/sermant-agent/agent/sermant-agent.jar=appName=default</code> in <code>spec &gt; containers &gt; env</code>.</p></li> <li><p>Check if the value of <code>spec &gt; containers &gt; initContainers &gt; image</code> is the image address used to build the sermant-agent image.</p></li></ol> <p>Execute the following command, where <code>${pod_name}</code> is the pod name of host application and <code>${namespace}</code> is the namespace name of deployed host application.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl logs <span class="token variable">${pod_name}</span> <span class="token parameter variable">-n</span> <span class="token variable">${namespace}</span>
</code></pre></div><ol start="3"><li>Check if the beginning of the pod log in the output of the above command contains:</li></ol> <div class="language- extra-class"><pre class="language-text"><code>[INFO] Loading sermant agent...
</code></pre></div><p>If the above information is correct, the sermant-agent has been successfully mounted into the host application.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/18/2023, 3:18:50 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/en/document/user-guide/configuration-center.html" class="prev">
        Dynamic Configuration Center User Manual
      </a></span> <span class="next"><a href="/en/document/plugin/">
        Plugin
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.56245a25.js" defer></script><script src="/assets/js/3.c22b673d.js" defer></script><script src="/assets/js/1.9e8b067b.js" defer></script><script src="/assets/js/48.6f183f8c.js" defer></script>
  </body>
</html>
