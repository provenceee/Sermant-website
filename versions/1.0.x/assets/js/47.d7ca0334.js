(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{492:function(t,e,a){"use strict";a.r(e);var n=a(26),s=Object(n.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"sermant-injector-user-manual"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sermant-injector-user-manual"}},[t._v("#")]),t._v(" Sermant-injector User Manual")]),t._v(" "),e("p",[t._v("Sermant-injector is based on the "),e("strong",[t._v("Kubernetes Admission Controllers.")]),t._v(" The admission controller is located in the K8s API Server and is able to intercept requests to the API Server to complete operations such as authentication, authorization, and mutation. This article introduces how to use the sermant-injector component to realize the rapid deployment of the host application to automatically mount the sermant-agent package in the k8s environment.")]),t._v(" "),e("p",[t._v("Sermant-injector is a MutatingAdmissionWebhook that can intercept and modify requests before creating container resources. After sermant-injector is deployed on K8s, just add "),e("code",[t._v("sermant-injection:Enabled")]),t._v(" to the YAML file of the host application deployment configuration at the "),e("code",[t._v("spec > Template > metadata> labels")]),t._v(" ' then the host application can automatically mount the sermant-agent package. Additionally, sermant-injector supports configuring environment variables via "),e("code",[t._v("annotations")]),t._v(". How the deployed applications can automatically mount Sermant and configure environment variables via "),e("code",[t._v("annotations")]),t._v(" is described in [Deploy Host Application](# deploy-host-application) below.")]),t._v(" "),e("h2",{attrs:{id:"parameter-configuration"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#parameter-configuration"}},[t._v("#")]),t._v(" Parameter Configuration")]),t._v(" "),e("h3",{attrs:{id:"parameter-configuration-for-sermant-injector"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#parameter-configuration-for-sermant-injector"}},[t._v("#")]),t._v(" Parameter Configuration for sermant-injector")]),t._v(" "),e("p",[t._v("This project adopts  Helm for Kubernetes package management. The parameters for deploying sermant-injector are set in "),e("a",{attrs:{href:"https://github.com/huaweicloud/Sermant/blob/develop/sermant-injector/deployment/release/injector/values.yaml",target:"_blank",rel:"noopener noreferrer"}},[t._v("sermant-injector/deployment/release/values.yaml"),e("OutboundLink")],1),t._v(".")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("injector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("addr")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pullPolicy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IfNotPresent\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pullSecrets")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("secret\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("agent")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("addr")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pullPolicy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IfNotPresent\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("config")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ZOOKEEPER\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("endpoints")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//localhost"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("30110")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("registry")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("endpoints")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//localhost"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("30100")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("configMap")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespaces")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("default"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n")])])]),e("p",[t._v("The parameters are described as follows:")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[e("span",{staticStyle:{display:"inline-block",width:"100px"}},[t._v("Primary Parameter Key")])]),t._v(" "),e("th",[e("span",{staticStyle:{display:"inline-block",width:"120px"}},[t._v("SecondÂ Parameter Key")])]),t._v(" "),e("th",[e("span",{staticStyle:{display:"inline-block",width:"100px"}},[t._v("Third Parameter Key")])]),t._v(" "),e("th",[t._v("Description")]),t._v(" "),e("th",[e("span",{staticStyle:{display:"inline-block",width:"80px"}},[t._v("Required")])])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("namespace")]),t._v(" "),e("td",[t._v("name")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("The namespace where the sermant-injector resides.")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td",[t._v("injector")]),t._v(" "),e("td",[t._v("replicas")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("Number of deployed sermant-injector instances.")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("image")]),t._v(" "),e("td",[t._v("addr")]),t._v(" "),e("td",[t._v("The mirror address of sermant-injector.")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td"),t._v(" "),e("td",[t._v("pullPolicy")]),t._v(" "),e("td",[t._v("Sermant-injector image pull strategy: Always(always pull), IfNotPresent(default value, use local mirror if exists), Never(only use local mirror and never pull).")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td"),t._v(" "),e("td",[t._v("pullSecrets")]),t._v(" "),e("td",[t._v("Pull secrets. The default key is default-secret and you can change it on command.")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td",[t._v("agent")]),t._v(" "),e("td",[t._v("image")]),t._v(" "),e("td",[t._v("addr")]),t._v(" "),e("td",[t._v("The mirror address of sermant-agent.")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td"),t._v(" "),e("td",[t._v("pullPolicy")]),t._v(" "),e("td",[t._v("Sermant-agent image pull strategy: Always(always pull), IfNotPresent(default value, use local mirror if exists), Never(only use local mirror and never pull).")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td",[t._v("config")]),t._v(" "),e("td",[t._v("type")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("Configuration center type of sermant-agent: Currently two types are supported, ZOOKEEPER and KIE.")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("endpoints")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("Configuration center address of sermant-agent.")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td",[t._v("registry")]),t._v(" "),e("td",[t._v("endpoints")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("Registration center address of sermant-agent.")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td",[t._v("configMap")]),t._v(" "),e("td",[t._v("enabled")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("Common environment variable configuration switch. The default value is false. Set it to true if you want to config common environment variables.")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("namespaces")]),t._v(" "),e("td",[t._v("-")]),t._v(" "),e("td",[t._v("The namespaces to be injected with configMap which must be the same as that of the service application.")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td",[t._v("env")]),t._v(" "),e("td",[t._v("custom key1")]),t._v(" "),e("td",[t._v("You can configure custom value1.")]),t._v(" "),e("td",[t._v("False")])]),t._v(" "),e("tr",[e("td"),t._v(" "),e("td"),t._v(" "),e("td",[t._v("custom key2")]),t._v(" "),e("td",[t._v("You can configure custom value2.")]),t._v(" "),e("td",[t._v("False")])])])]),t._v(" "),e("p",[t._v("**Public environment variables configuration: **")]),t._v(" "),e("p",[t._v("Sermant-injector supports configuring custom environment variables for the host application in pod. Just modifying the content of the "),e("code",[t._v("configMap.env")]),t._v(" in "),e("code",[t._v("sermant-injector/deployment/release/injector/values.yaml")]),t._v(". The prerequisite is that "),e("code",[t._v("configMap.enabled")]),t._v(" is set to "),e("code",[t._v("true")]),t._v(", and "),e("code",[t._v("configMap.namespace")]),t._v(" is configured correctly. Common environment variables can be configured as follows (kv form) :")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("configMap")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespaces")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("default"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" test"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  \t"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("TEST_ENV1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" abc\n  \t"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("TEST_ENV2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v("\n")])])]),e("p",[t._v("For example, during the use of Sermant, certain configurations are common to all pods in the current k8s cluster, such as ip and port of the "),e("strong",[t._v("Backend")]),t._v(". You can configure it here:")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("configMap")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespaces")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("default"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\t\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  \t"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("backend.nettyIp")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 127.0.0.1\n  \t"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("backend.nettyPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8900")]),t._v("\n")])])]),e("p",[t._v("All sermants in pods of default namespace are connected to the "),e("strong",[t._v("Backend")]),t._v(".")]),t._v(" "),e("p",[e("strong",[t._v("Note")]),t._v(" : The priority of environment variables configured "),e("code",[t._v("configMap")]),t._v("  is lower than that of "),e("code",[t._v("env")]),t._v(" in yaml of host application. Because "),e("code",[t._v("config.type")]),t._v(", "),e("code",[t._v("config.endpoints")]),t._v(", and "),e("code",[t._v("registry.endpoints")]),t._v(" are essentially "),e("code",[t._v("env")]),t._v(" loaded environment variables, they also take precedence over the corresponding sermant environment variables configured with "),e("code",[t._v("configMap")]),t._v(".")]),t._v(" "),e("h3",{attrs:{id:"parameter-configuration-for-mirror-scripts"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#parameter-configuration-for-mirror-scripts"}},[t._v("#")]),t._v(" Parameter Configuration for mirror scripts")]),t._v(" "),e("p",[e("strong",[e("a",{attrs:{href:"https://github.com/huaweicloud/Sermant/blob/develop/sermant-injector/images/sermant-agent/build-sermant-image.sh",target:"_blank",rel:"noopener noreferrer"}},[t._v("build-sermant-image.sh"),e("OutboundLink")],1)])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("Parameters")]),t._v(" "),e("th",[t._v("Description")]),t._v(" "),e("th",[t._v("Required")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("sermantVersion")]),t._v(" "),e("td",[t._v("Version of sermant-agent-x.x.x.tar.gz")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td",[t._v("imageName")]),t._v(" "),e("td",[t._v("Image name of sermant-agent mirror")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td",[t._v("imageVersion")]),t._v(" "),e("td",[t._v("Image version of sermant-agent mirror")]),t._v(" "),e("td",[t._v("True")])])])]),t._v(" "),e("p",[e("strong",[e("a",{attrs:{href:"https://github.com/huaweicloud/Sermant/blob/develop/sermant-injector/images/injector/build-injector-image.sh",target:"_blank",rel:"noopener noreferrer"}},[t._v("build-injector-image.sh"),e("OutboundLink")],1)])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("Parameters")]),t._v(" "),e("th",[t._v("Description")]),t._v(" "),e("th",[t._v("Required")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("imageName")]),t._v(" "),e("td",[t._v("Image name of sermant-injector mirror")]),t._v(" "),e("td",[t._v("True")])]),t._v(" "),e("tr",[e("td",[t._v("imageVersion")]),t._v(" "),e("td",[t._v("Image version of sermant-injector mirror")]),t._v(" "),e("td",[t._v("True")])])])]),t._v(" "),e("h2",{attrs:{id:"version-supported"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#version-supported"}},[t._v("#")]),t._v(" Version Supported")]),t._v(" "),e("p",[t._v("Sermant-injector currently supports Kubernetes 1.15+ and deploys with Helm v3 for Kubernetes package management.")]),t._v(" "),e("ul",[e("li",[e("p",[e("a",{attrs:{href:"https://kubernetes.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Kubernetes 1.15+"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://helm.sh/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Helm v3.1+"),e("OutboundLink")],1)])])]),t._v(" "),e("h2",{attrs:{id:"startup-and-result-validation"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#startup-and-result-validation"}},[t._v("#")]),t._v(" Startup and Result Validation")]),t._v(" "),e("p",[t._v("Before deploying "),e("strong",[t._v("sermant-injector")]),t._v(", you need to build the "),e("strong",[t._v("sermant-agent")]),t._v(" image and the "),e("strong",[t._v("sermant-injector")]),t._v(" image.")]),t._v(" "),e("h3",{attrs:{id:"build-image-of-sermant-agent"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#build-image-of-sermant-agent"}},[t._v("#")]),t._v(" Build Image of Sermant-agent")]),t._v(" "),e("h4",{attrs:{id:"prepare-sermant-agent-package"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#prepare-sermant-agent-package"}},[t._v("#")]),t._v(" Prepare Sermant-agent package")]),t._v(" "),e("p",[t._v("Click "),e("a",{attrs:{href:"https://github.com/huaweicloud/Sermant/releases",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),e("OutboundLink")],1),t._v(" to download latest release package "),e("code",[t._v("sermant-agent-x.x.x.tar.gz")]),t._v(" or you can package sermant yourself.")]),t._v(" "),e("h4",{attrs:{id:"build-image"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#build-image"}},[t._v("#")]),t._v(" Build Image")]),t._v(" "),e("p",[t._v("Modify the values of "),e("code",[t._v("sermantVersion")]),t._v(", "),e("code",[t._v("imageName")]),t._v(" and "),e("code",[t._v("imageVerison")]),t._v(" in the "),e("code",[t._v("build-sermant-image.sh")]),t._v(" under "),e("code",[t._v("images/sermant-agent")]),t._v(" folder.")]),t._v(" "),e("p",[t._v("Move "),e("code",[t._v("build-sermant-image.sh")]),t._v(" and "),e("code",[t._v("Sermant.dockerfile")]),t._v(" to the same directory as the release package "),e("code",[t._v("sermant-agent-xxx.tar.gz")]),t._v(" in one of K8s nodes. Run "),e("code",[t._v("build-sermant-image.sh")]),t._v(" to build the sermant-agent image.")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sh")]),t._v(" build-sermant-image.sh\n")])])]),e("p",[t._v("To push the image to the image repository, run the "),e("code",[t._v("docker push ${imageName}:{imageVerison}")]),t._v(" command.")]),t._v(" "),e("h3",{attrs:{id:"build-image-of-sermant-injector"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#build-image-of-sermant-injector"}},[t._v("#")]),t._v(" Build Image of Sermant-injector")]),t._v(" "),e("h4",{attrs:{id:"package-sermant-injector"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#package-sermant-injector"}},[t._v("#")]),t._v(" Package Sermant-injector")]),t._v(" "),e("p",[t._v("Execute the "),e("code",[t._v("mvn clean package")]),t._v(" command to generate the "),e("code",[t._v("sermant-injector.jar")]),t._v(" file in the directory of sermant-injector project.")]),t._v(" "),e("h4",{attrs:{id:"build-image-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#build-image-2"}},[t._v("#")]),t._v(" Build Image")]),t._v(" "),e("p",[t._v("Modify the values of "),e("code",[t._v("imageName")]),t._v(" and "),e("code",[t._v("imageVerison")]),t._v(" in the "),e("code",[t._v("build-injector-image.sh")]),t._v(" script under "),e("code",[t._v("images/injector")]),t._v(" folder.")]),t._v(" "),e("p",[t._v("Move "),e("code",[t._v("build-injector-image.sh")]),t._v(", "),e("code",[t._v("start.sh")]),t._v(" and "),e("code",[t._v("Injector.Dockerfile")]),t._v(" to the same directory as the package "),e("code",[t._v("sermant-injector.jar")]),t._v(". Run "),e("code",[t._v("build-injector-image.sh")]),t._v(" to create the sermant-injector image.")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sh")]),t._v(" build-injector-image.sh\n")])])]),e("p",[t._v("To push the image to the image repository, run the "),e("code",[t._v("docker push ${imageName}:{imageVerison}")]),t._v(" command.")]),t._v(" "),e("h3",{attrs:{id:"deploy-workload-of-sermant-injector"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#deploy-workload-of-sermant-injector"}},[t._v("#")]),t._v(" Deploy Workload of Sermant-injector")]),t._v(" "),e("p",[t._v("Before the host application can be containerized, the workload of sermant-injector needs to be deployed. This project adopts Helm for Kubernetes package management and uses Chart template in"),e("code",[t._v("injector")]),t._v(" under "),e("code",[t._v("deploment/release")]),t._v(".")]),t._v(" "),e("p",[t._v("Modify the template variable in "),e("code",[t._v("values.yaml")]),t._v(" according to the actual environment. Once this is done, execute "),e("code",[t._v("helm install")]),t._v(" to deploy the sermant-injector workload in K8s:")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("helm "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" sermant-injector "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("/injector\n")])])]),e("p",[t._v("Check that the status of the deployed pod of sermant-injector is running.")]),t._v(" "),e("p",[t._v("At this point, the environment configuration of the host application before deployment is complete.")]),t._v(" "),e("h3",{attrs:{id:"deploy-host-application"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#deploy-host-application"}},[t._v("#")]),t._v(" Deploy Host Application")]),t._v(" "),e("p",[e("strong",[t._v("Mount Sermant Automatically")])]),t._v(" "),e("p",[t._v("After the deployment of above sermant-injector, developers should write YAML file to deploy K8s Deployment resources according to the actual application. Simply add "),e("code",[t._v("sermant-injection: enabled")]),t._v(" at the "),e("code",[t._v("spec > Template > Metadata > Labels")]),t._v(" to automatically mount the sermant-agent. (If you do not want to mount it later, just delete it and restart the application)")]),t._v(" "),e("p",[e("strong",[t._v("Configure Environment Variables via Annotations")])]),t._v(" "),e("p",[t._v("If you want to configure custom environment variables in K8s Deployment, simply add the corresponding key-value pair in the "),e("code",[t._v("spec > template > metadata> annotations")]),t._v(". For details about the configuration, see the following example.")]),t._v(" "),e("p",[t._v("Take "),e("code",[t._v('env.sermant.io/key1: "value1"')]),t._v(" as an example, the configuration rules are: "),e("code",[t._v("env.sermant.io/")]),t._v(" is the standard prefix for configuring environment variables through "),e("code",[t._v("annotations")]),t._v(", "),e("code",[t._v("key1")]),t._v(" is the name of a custom environment variable that users configure on demand, and "),e("code",[t._v("value1")]),t._v(" is the value of a custom environment variable that users configure on demand.")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deployment\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("test\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("test\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("test\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLabels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("test\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("test\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sermant-injection")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" enabled\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("annotations")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env.sermant.io/key1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value1"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env.sermant.io/key2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value2"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" image\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Please replace it with own image")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" image"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("1.0.0\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containerPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8443")]),t._v("\n")])])]),e("p",[t._v("If the pod cannot be created, check that the sermant-injector is deployed correctly and that the sermant-agent image is built correctly.")]),t._v(" "),e("h3",{attrs:{id:"verification"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#verification"}},[t._v("#")]),t._v(" Verification")]),t._v(" "),e("p",[t._v("Once the pod is created, execute the following command, where "),e("code",[t._v("${pod_name}")]),t._v(" is the pod name of host application.")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("kubectl get po/"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${pod_name}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-o")]),t._v(" yaml\n")])])]),e("ol",[e("li",[e("p",[t._v("Check if the output contains the environment variable whose name is "),e("code",[t._v("JAVA_TOOL_OPTIONS")]),t._v("and value is "),e("code",[t._v("-javaagent:/home/sermant-agent/agent/sermant-agent.jar=appName=default")]),t._v(" in "),e("code",[t._v("spec > containers > env")]),t._v(".")])]),t._v(" "),e("li",[e("p",[t._v("Check if the value of "),e("code",[t._v("spec > containers > initContainers > image")]),t._v(" is the image address used to build the sermant-agent image.")])])]),t._v(" "),e("p",[t._v("Execute the following command, where "),e("code",[t._v("${pod_name}")]),t._v(" is the pod name of host application and "),e("code",[t._v("${namespace}")]),t._v(" is the namespace name of deployed host application.")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("kubectl logs "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${pod_name}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${namespace}")]),t._v("\n")])])]),e("ol",{attrs:{start:"3"}},[e("li",[t._v("Check if the beginning of the pod log in the output of the above command contains:")])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[INFO] Loading sermant agent...\n")])])]),e("p",[t._v("If the above information is correct, the sermant-agent has been successfully mounted into the host application.")])])}),[],!1,null,null,null);e.default=s.exports}}]);