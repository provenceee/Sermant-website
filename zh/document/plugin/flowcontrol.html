<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>流控 | Sermant</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/logo.svg">
    <meta name="description" content="一种基于Java Agent的无代理服务网格解决方案">
    
    <link rel="preload" href="/assets/css/0.styles.934e6042.css" as="style"><link rel="preload" href="/assets/js/app.56245a25.js" as="script"><link rel="preload" href="/assets/js/3.c22b673d.js" as="script"><link rel="preload" href="/assets/js/1.9e8b067b.js" as="script"><link rel="preload" href="/assets/js/75.7fb65875.js" as="script"><link rel="preload" href="/assets/js/14.7039f4a7.js" as="script"><link rel="prefetch" href="/assets/js/10.ca8549df.js"><link rel="prefetch" href="/assets/js/11.6a8571e0.js"><link rel="prefetch" href="/assets/js/12.3caa9ab5.js"><link rel="prefetch" href="/assets/js/13.b1f0a423.js"><link rel="prefetch" href="/assets/js/15.36703cc8.js"><link rel="prefetch" href="/assets/js/16.804e91c8.js"><link rel="prefetch" href="/assets/js/17.0f65b007.js"><link rel="prefetch" href="/assets/js/18.92d1be28.js"><link rel="prefetch" href="/assets/js/19.ce355d42.js"><link rel="prefetch" href="/assets/js/20.89bea0c7.js"><link rel="prefetch" href="/assets/js/21.945c9d2a.js"><link rel="prefetch" href="/assets/js/22.92e167cf.js"><link rel="prefetch" href="/assets/js/23.f67f4b5e.js"><link rel="prefetch" href="/assets/js/24.69a732d8.js"><link rel="prefetch" href="/assets/js/25.4876205d.js"><link rel="prefetch" href="/assets/js/26.6739bd0c.js"><link rel="prefetch" href="/assets/js/27.8e5c7da7.js"><link rel="prefetch" href="/assets/js/28.bfac4c9e.js"><link rel="prefetch" href="/assets/js/29.53aabd90.js"><link rel="prefetch" href="/assets/js/30.a9d9a2a9.js"><link rel="prefetch" href="/assets/js/31.60ffcf24.js"><link rel="prefetch" href="/assets/js/32.3173505b.js"><link rel="prefetch" href="/assets/js/33.545c5274.js"><link rel="prefetch" href="/assets/js/34.00264371.js"><link rel="prefetch" href="/assets/js/35.276e3817.js"><link rel="prefetch" href="/assets/js/36.b0d41169.js"><link rel="prefetch" href="/assets/js/37.2fad2a48.js"><link rel="prefetch" href="/assets/js/38.0aa576a4.js"><link rel="prefetch" href="/assets/js/39.4757bdce.js"><link rel="prefetch" href="/assets/js/4.94f1233f.js"><link rel="prefetch" href="/assets/js/40.416a30c0.js"><link rel="prefetch" href="/assets/js/41.fee59cd9.js"><link rel="prefetch" href="/assets/js/42.d0f88052.js"><link rel="prefetch" href="/assets/js/43.2be6fc39.js"><link rel="prefetch" href="/assets/js/44.16c1ffcf.js"><link rel="prefetch" href="/assets/js/45.9c66aab6.js"><link rel="prefetch" href="/assets/js/46.0c089932.js"><link rel="prefetch" href="/assets/js/47.6b16ba66.js"><link rel="prefetch" href="/assets/js/48.6f183f8c.js"><link rel="prefetch" href="/assets/js/49.8236e4a0.js"><link rel="prefetch" href="/assets/js/5.05c6b3e9.js"><link rel="prefetch" href="/assets/js/50.91ee7d0a.js"><link rel="prefetch" href="/assets/js/51.3890a4c6.js"><link rel="prefetch" href="/assets/js/52.76c23ee8.js"><link rel="prefetch" href="/assets/js/53.3b3b4ad4.js"><link rel="prefetch" href="/assets/js/54.8c695126.js"><link rel="prefetch" href="/assets/js/55.24d58397.js"><link rel="prefetch" href="/assets/js/56.a73657ef.js"><link rel="prefetch" href="/assets/js/57.4b02d6af.js"><link rel="prefetch" href="/assets/js/58.08717c67.js"><link rel="prefetch" href="/assets/js/59.e6514139.js"><link rel="prefetch" href="/assets/js/6.d82aff6e.js"><link rel="prefetch" href="/assets/js/60.5410266f.js"><link rel="prefetch" href="/assets/js/61.59e38702.js"><link rel="prefetch" href="/assets/js/62.96273134.js"><link rel="prefetch" href="/assets/js/63.807a4412.js"><link rel="prefetch" href="/assets/js/64.fd39dc04.js"><link rel="prefetch" href="/assets/js/65.afef1e74.js"><link rel="prefetch" href="/assets/js/66.3a7aeeab.js"><link rel="prefetch" href="/assets/js/67.42b5b39d.js"><link rel="prefetch" href="/assets/js/68.dab77e43.js"><link rel="prefetch" href="/assets/js/69.59b843c2.js"><link rel="prefetch" href="/assets/js/7.0aa4fbf2.js"><link rel="prefetch" href="/assets/js/70.ea2db599.js"><link rel="prefetch" href="/assets/js/71.dd9084fc.js"><link rel="prefetch" href="/assets/js/72.4828d1d6.js"><link rel="prefetch" href="/assets/js/73.b644410d.js"><link rel="prefetch" href="/assets/js/74.7626c55a.js"><link rel="prefetch" href="/assets/js/76.899c626b.js"><link rel="prefetch" href="/assets/js/77.90d41e21.js"><link rel="prefetch" href="/assets/js/78.edaa0b7b.js"><link rel="prefetch" href="/assets/js/79.e9e1e72a.js"><link rel="prefetch" href="/assets/js/8.fe2e589f.js"><link rel="prefetch" href="/assets/js/80.b2cde3fe.js"><link rel="prefetch" href="/assets/js/81.90984771.js"><link rel="prefetch" href="/assets/js/82.ea554216.js"><link rel="prefetch" href="/assets/js/83.0e507f62.js"><link rel="prefetch" href="/assets/js/84.5306af9d.js"><link rel="prefetch" href="/assets/js/85.57b25843.js"><link rel="prefetch" href="/assets/js/86.3aefe1fd.js"><link rel="prefetch" href="/assets/js/87.cc73ef62.js"><link rel="prefetch" href="/assets/js/88.f36833ec.js"><link rel="prefetch" href="/assets/js/89.73f38fbd.js"><link rel="prefetch" href="/assets/js/9.623da9fe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.934e6042.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/img/sermant-logo.png" alt="Sermant" class="logo"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/document/" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/zh/blog/" class="nav-link">
  博客
</a></div><div class="nav-item"><a href="https://github.com/huaweicloud/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/plugin/flowcontrol.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/plugin/flowcontrol.html" class="nav-link">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/document/" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/zh/blog/" class="nav-link">
  博客
</a></div><div class="nav-item"><a href="https://github.com/huaweicloud/Sermant" target="_blank" class="nav-link external">
  Github
  <!----></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/document/plugin/flowcontrol.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/en/document/plugin/flowcontrol.html" class="nav-link">
  English
</a></li></ul></div></div> <div class="nav-item"><!----></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>开始</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>用户使用手册</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>插件使用手册</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/document/plugin/" aria-current="page" class="sidebar-link">插件介绍</a></li><li><a href="/zh/document/plugin/dynamic-config.html" class="sidebar-link">动态配置</a></li><li><a href="/zh/document/plugin/flowcontrol.html" aria-current="page" class="active sidebar-link">流控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/document/plugin/flowcontrol.html#功能介绍" class="sidebar-link">功能介绍</a></li><li class="sidebar-sub-header"><a href="/zh/document/plugin/flowcontrol.html#参数配置" class="sidebar-link">参数配置</a></li><li class="sidebar-sub-header"><a href="/zh/document/plugin/flowcontrol.html#详细治理规则" class="sidebar-link">详细治理规则</a></li><li class="sidebar-sub-header"><a href="/zh/document/plugin/flowcontrol.html#支持版本与限制" class="sidebar-link">支持版本与限制</a></li><li class="sidebar-sub-header"><a href="/zh/document/plugin/flowcontrol.html#操作和结果验证" class="sidebar-link">操作和结果验证</a></li></ul></li><li><a href="/zh/document/plugin/graceful.html" class="sidebar-link">无损上下线</a></li><li><a href="/zh/document/plugin/loadbalancer.html" class="sidebar-link">负载均衡</a></li><li><a href="/zh/document/plugin/monitor.html" class="sidebar-link">监控</a></li><li><a href="/zh/document/plugin/router.html" class="sidebar-link">标签路由</a></li><li><a href="/zh/document/plugin/register-migration.html" class="sidebar-link">注册迁移</a></li><li><a href="/zh/document/plugin/springboot-registry.html" class="sidebar-link">SpringBoot 注册</a></li><li><a href="/zh/document/plugin/visibility.html" class="sidebar-link">服务可见性</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>开发者指南</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>加入社区</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>FAQ</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="流控"><a href="#流控" class="header-anchor">#</a> 流控</h1> <p>本文介绍如何使用<a href="https://github.com/huaweicloud/Sermant/tree/develop/sermant-plugins/sermant-flowcontrol" target="_blank" rel="noopener noreferrer">流控插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="功能介绍"><a href="#功能介绍" class="header-anchor">#</a> 功能介绍</h2> <p>流控插件基于<a href="https://github.com/resilience4j" target="_blank" rel="noopener noreferrer">resilience4j<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 框架，以&quot;流量&quot;切入点，实现&quot;无侵入式&quot;流量控制；当前支持<strong>限流</strong>、<strong>熔断</strong>、<strong>隔离仓</strong>、<strong>错误注入</strong>与<strong>重试</strong>、<strong>熔断指标采集</strong>、<strong>系统规则</strong>、<strong>系统自适应</strong>流控能力，并且支持配置中心动态配置规则，实时生效。</p> <ul><li><strong>限流</strong>：对指定接口限制1S秒内通过的QPS，当1S内流量超过指定阈值，将触发流控，限制请求流量，在客户端和服务端都可生效。</li> <li><strong>熔断</strong>：对指定接口配置熔断策略，可从单位统计时间窗口内的错误率或者慢请求率进行统计，当请求错误率或者慢请求率达到指定比例阈值，即触发熔断，在时间窗口重置前，隔离所有请求，在客户端和服务端都可生效。</li> <li><strong>隔离仓</strong>：对指定接口设置允许的最大并发量，当超过最大并发量时，对并发流量进行排队等待控制，等待超过最大等待时间则拒绝调用，避免瞬时并发流量过大导致服务崩溃，在客户端和服务端都可生效。</li> <li><strong>重试</strong>：当服务遇到非致命的错误时，可以通过重试的方式避免服务的最终失败。</li> <li><strong>错误注入</strong>：指在服务运行时，给指定服务配置错误注入策略，在客户端访问目标服务前，以指定策略模式返回。该策略多用于减少目标服务的访问负载，可作为降级的一种措施。</li> <li><strong>熔断指标采集</strong>：当服务配置了熔断策略后，插件会异步采集熔断的相关信息，并通过<a href="/zh/document/plugin/monitor.html">监控插件</a>进行指标上报。</li> <li><strong>系统规则</strong>：在服务运行时，若系统负载，CPU使用率，并发线程数，请求平均响应时间，请求qps任意指标超出阈值，将触发流控，限制请求流量。</li> <li><strong>系统自适应</strong>：在服务运行时，根据系统当前负载状态，以及过去一段时间内系统数据，对请求进行自适应流控。</li></ul> <h2 id="参数配置"><a href="#参数配置" class="header-anchor">#</a> 参数配置</h2> <h3 id="sermant-agent配置"><a href="#sermant-agent配置" class="header-anchor">#</a> Sermant-agent配置</h3> <p>流控插件依赖动态配置中心，需要在Sermant-agent中配置动态配置中心的地址（<code>dynamic.config.serverAddress</code>），动态配置中心的类型（<code>dynamic.config.dynamicConfigType</code>），具体参考<a href="/zh/document/user-guide/sermant-agent.html#sermant-agent使用参数配置">Sermant-agent使用手册</a>。</p> <h3 id="插件配置"><a href="#插件配置" class="header-anchor">#</a> 插件配置</h3> <p>流控插件需打开是否开启ServiceComb适配（<code>flow.control.plugin.useCseRule</code>），是否开启指标监控（<code>flow.control.plugin.enable-start-monitor</code>）等开关，可在<code>${path}/sermant-agent-x.x.x/agent/pluginPackage/flowcontrol/config/config.yaml</code>找到插件的配置文件，配置如下所示：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">flow.control.plugin</span><span class="token punctuation">:</span>
  <span class="token key atrule">useCseRule</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 是否开启ServiceComb适配</span>
  <span class="token key atrule">enable-start-monitor</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 是否启动指标监控</span>
  <span class="token key atrule">enable-system-adaptive</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 是否开启系统自适应流控,开启此开关需enable-system-rule配置项也开启</span>
  <span class="token key atrule">enable-system-rule</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 是否开启系统规则流控</span>
</code></pre></div><table><thead><tr><th style="text-align:left;">参数键</th> <th>说明</th> <th>默认值</th> <th>是否必须</th></tr></thead> <tbody><tr><td style="text-align:left;">useCseRule</td> <td>是否开启ServiceComb适配; <br> <strong>true</strong>:插件根据应用配置,服务配置,自定义标签订阅配置 <br> <strong>false</strong>:插件根据实例服务名进行配置订阅</td> <td>true</td> <td>是</td></tr> <tr><td style="text-align:left;">enable-start-monitor</td> <td>是否开启指标监控; <strong>true</strong>:熔断指标数据通过监控插件上传至Prometheus，详情查看<a href="/zh/document/plugin/monitor.html">监控插件</a></td> <td>false</td> <td>否</td></tr> <tr><td style="text-align:left;">enable-system-adaptive</td> <td>是否开启系统自适应流控; <br> <strong>true</strong>:根据系统负载对请求流量进行自适应流控</td> <td>false</td> <td>否</td></tr> <tr><td style="text-align:left;">enable-system-rule</td> <td>是否开启系统规则流控; <br> <strong>true</strong>:根据流控策略中的系统参数阈值进行流控</td> <td>false</td> <td>否</td></tr></tbody></table> <blockquote><p>useCseRule说明： Sermant当前支持zookeeper和ServiceComb-kie配置中心，默认采用zookeeper配置中心，若用户使用ServiceComb-kie，则需要设置<strong>useCseRule</strong>配置为<strong>true</strong></p></blockquote> <h2 id="详细治理规则"><a href="#详细治理规则" class="header-anchor">#</a> 详细治理规则</h2> <p>流控配置主要基于<code>group</code>进行配置订阅，该<code>group</code>由多个键值对组成。下面详细说明<code>group</code>和键值对<code>key</code>和<code>value</code>的设置规则。</p> <blockquote><p>关于<code>group</code> <code>key</code> 的介绍以及配置中心的设置参考<a href="/zh/document/user-guide/configuration-center.html#发布配置">动态配置中心使用手册</a>。</p></blockquote> <h4 id="根据采用配置中心的不同-group的值将会有所区别-以下介绍group的设置规则"><a href="#根据采用配置中心的不同-group的值将会有所区别-以下介绍group的设置规则" class="header-anchor">#</a> 根据采用配置中心的不同，<code>group</code>的值将会有所区别,以下介绍<code>group</code>的设置规则：</h4> <ul><li><p>采用<code>zookeeper</code></p> <p>此时插件将根据宿主应用的服务名进行订阅, 即应用配置的<code>spring.applicaton.name</code>, 插件订阅配置的group为<code>service=${spring.applicaton.name}</code>。</p></li> <li><p>采用<code>KIE</code></p> <p>此时插件将根据<strong>应用配置</strong>，<strong>服务配置</strong>以及<strong>自定义配置</strong>三项数据配置<strong>同时</strong>订阅， 而这三类配置可参考<code>${path}/sermant-agent-x.x.x/agent/config/config.properties</code>, 相关配置如下：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># 服务app名称</span>
<span class="token key attr-name">service.meta.application</span><span class="token punctuation">=</span><span class="token value attr-value">default</span>
<span class="token comment"># 服务版本</span>
<span class="token key attr-name">service.meta.version</span><span class="token punctuation">=</span><span class="token value attr-value">1.0.0</span>
<span class="token comment"># serviceComb 命名空间</span>
<span class="token key attr-name">service.meta.project</span><span class="token punctuation">=</span><span class="token value attr-value">default</span>
<span class="token comment"># 环境</span>
<span class="token key attr-name">service.meta.environment</span><span class="token punctuation">=</span><span class="token value attr-value">development</span>
<span class="token comment"># 自定义标签，按需配置，用于后续的配置订阅</span>
<span class="token key attr-name">service.meta.customLabel</span><span class="token punctuation">=</span><span class="token value attr-value">public</span>
<span class="token key attr-name">service.meta.customLabelValue</span><span class="token punctuation">=</span><span class="token value attr-value">default</span>
</code></pre></div><p>应用配置，服务配置，自定义配置说明参考<a href="https://support.huaweicloud.com/devg-cse/cse_devg_0020.html" target="_blank" rel="noopener noreferrer">CSE配置中心概述<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <ul><li>应用配置：由<code>service.meta.application</code>与<code>service.meta.environment</code>组成， 对应的<code>group</code>为<code>app=default&amp;environment=development</code>。</li> <li>服务配置：由<code>service.meta.application</code>、<code>service.meta.environment</code>以及服务名组成，此处服务即<code>spring.application.name</code>, 对应的<code>group</code>为<code>app=default&amp;environment=development&amp;service=DynamicConfigDemo</code>。</li> <li>自定义配置：由<code>service.meta.customLabel</code>与<code>service.meta.customLabelValue</code>组成， 对应的<code>group</code>为<code>public=default</code>。</li></ul></li></ul> <h4 id="流控插件根据配置键key的前缀进行规则匹配-以下介绍配置键key的规则"><a href="#流控插件根据配置键key的前缀进行规则匹配-以下介绍配置键key的规则" class="header-anchor">#</a> 流控插件根据配置键<code>key</code>的前缀进行规则匹配，以下介绍配置键<code>key</code>的规则：</h4> <p>流量治理采用流量标记+流控规则的方式对指定的流量进行流控，所谓流量标记，通俗讲为请求信息，例如接口路径、接口方法类型、请求头以及下游服务名。</p> <p>流控规则是否生效取决于流量标记，当流量标记与请求相匹配，流控规则才会生效。而如何将流量标记对应上具体规则，则取决于业务场景名，通常流量标记与流控规则配置均要配置指定前缀。</p> <p>例如流量标记的键key需以<code>servicecomb.MatchGroup</code>为前缀, 而限流规则的键key需以<code>servicecomb.rateLimiting</code>为前缀，以一个具体的例子：</p> <blockquote><p>流量标记配置键key为：<code>servicecomb.MatchGroup.flow</code>。</p> <p>限流规则配置键key为：<code>servicecomb.rateLimiting.flow</code>。</p> <p>如上，<code>flow</code>即为业务场景名，仅当两者业务场景名称一致，当请求匹配上流量标记时，限流规则才会生效。</p></blockquote> <h4 id="下面介绍流控规则配置键key对应值value的相关信息"><a href="#下面介绍流控规则配置键key对应值value的相关信息" class="header-anchor">#</a> 下面介绍流控规则配置键<code>key</code>对应值<code>value</code>的相关信息：</h4> <ul><li><p><strong>流量标记</strong></p> <p><strong>流量标记配置键前缀:</strong> <code>servicecomb.MatchGroup</code></p> <p>以<code>zookeeper</code>为例，当使用<code>zookeeper</code>配置中心设置流量标记规则时，结合上述<code>group</code>和<code>key</code>的说明，需要在<code>zookeeper</code>中创建节点<code>/service=${spring.applicaton.name}/servicecomb.MatchGroup.${sceneName}</code>,节点内容为流量标记规则，如下述yaml内容。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">matches</span><span class="token punctuation">:</span>            <span class="token comment"># 匹配器集合，可配置多个</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiPath</span><span class="token punctuation">:</span>          <span class="token comment"># 匹配的api路径， 支持各种比较方式，相等(exact)、包含(contains)等</span>
    <span class="token key atrule">exact</span><span class="token punctuation">:</span> /degrade <span class="token comment"># 具体匹配路径</span>
  <span class="token key atrule">headers</span><span class="token punctuation">:</span>          <span class="token comment"># 请求头</span>
    <span class="token key atrule">key</span><span class="token punctuation">:</span> 
      <span class="token key atrule">exact</span><span class="token punctuation">:</span> value  <span class="token comment"># 请求头值，此处为key=value, 比较方式同apiPath</span>
  <span class="token key atrule">method</span><span class="token punctuation">:</span>           <span class="token comment"># 支持方法类型</span>
  <span class="token punctuation">-</span> GET
  <span class="token key atrule">name</span><span class="token punctuation">:</span> degrade     <span class="token comment"># 可选，配置名</span>
</code></pre></div><p><strong>流量标记解释:</strong></p> <ul><li><p>请求路径为<code>/degrade</code>且方法类型为<code>GET</code>, 同时满足要求请求头包含<code>key=value</code>即匹配成功</p> <p>详细配置项可参考<a href="http://servicecomb.gitee.io/servicecomb-java-chassis-doc/java-chassis/zh_CN/references-handlers/governance.html#_2" target="_blank" rel="noopener noreferrer">ServiceComb开发文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 流量标记部分。</p></li></ul> <p><strong>流量标记请求路径（apiPath）配置说明</strong></p> <p>流量标记的请求路径会因不同的请求协议配置而存在差异，当前主要为Http（Spring）与Rpc（Dubbo）协议，下面分别说明两种请求协议的配置方式：</p> <ul><li><p>Http协议</p> <p>该协议依据请求路径进行匹配，例如请求路径为localhost:8080/test/flow, 则实际拿到的路径为<code>/test/flow</code>，因此若需设置匹配规则，需依据该路径进行配置。</p> <p>值得注意的是，如果用户配置了contextPath, 则需要加上contextPath前缀才可生效，即流量标记中请求路径为<code>${contextPath}/test/flow</code>。</p></li> <li><p>Rpc协议（Dubbo）</p> <p>该协议调用需要基于接口+方法，例如请求的接口为com.demo.test, 其方法为flow， 则对应的请求路径为<code>com.demo.test.flow</code>, 特别的，如果用户有配置接口的版本，例如指定的version为1.0.0， 则请求路径为<code>com.demo.test:1.0.0.flow</code>。同时需要配置请求方法为<code>POST</code>, RPC协议仅支持POST类型。</p></li></ul></li> <li><p><strong>限流</strong></p> <p><strong>限流规则配置键前缀：</strong> <code>servicecomb.rateLimiting</code></p> <p><strong>限流规则：</strong></p> <table><thead><tr><th>配置项</th> <th>说明</th> <th>默认值</th> <th>是否必须</th></tr></thead> <tbody><tr><td>limitRefreshPeriod</td> <td>单位统计时间，单位毫秒, 若需配置秒则可增加单位<code>S</code>， 例如<code>10S</code></td> <td>1000ms</td> <td>否</td></tr> <tr><td>rate</td> <td>单位统计时间所能通过的<strong>请求个数</strong></td> <td>1000</td> <td>否</td></tr></tbody></table> <p>以zookeeper为例，当使用<code>zookeeper</code>配置中心设置限流规则时，结合上述<code>group</code>和<code>key</code>的说明，需要在<code>zookeeper</code>中创建节点<code>/service=${spring.applicaton.name}/servicecomb.rateLimiting.${sceneName}</code>,节点内容为限流规则，如下述yaml内容：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">imitRefreshPeriod</span><span class="token punctuation">:</span> <span class="token number">1000</span>
<span class="token key atrule">rate</span><span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre></div><p><strong>上述限流规则解释：</strong> 若1秒内超过2个请求，即触发流控效果。</p></li> <li><p><strong>熔断</strong></p> <p><strong>熔断规则配置键前缀:</strong> <code>servicecomb.circuitBreaker</code></p> <p><strong>熔断规则：</strong></p> <table><thead><tr><th>配置项</th> <th>说明</th> <th>默认值</th> <th>是否必须</th></tr></thead> <tbody><tr><td>failureRateThreshold</td> <td>熔断所需达到的错误率</td> <td>50</td> <td>否</td></tr> <tr><td>minimumNumberOfCalls</td> <td>滑动窗口内的最小请求数， 超过最小请求数才开始判断熔断条件</td> <td>100</td> <td>否</td></tr> <tr><td>name</td> <td>配置项名称，可选参数</td> <td>null</td> <td>否</td></tr> <tr><td>slidingWindowSize</td> <td>滑动统计窗口大小，支持毫秒与秒，例如<code>1000</code>为1000毫秒, <code>10S</code>代表10秒</td> <td>100ms</td> <td>否</td></tr> <tr><td>slidingWindowType</td> <td>滑动窗口类型，目前支持<code>time</code>与<code>count</code>两种类型，前者基于时间窗口统计，后者基于请求次数</td> <td>time</td> <td>否</td></tr> <tr><td>slowCallDurationThreshold</td> <td>慢请求阈值，单位同滑动窗口配置</td> <td>60s</td> <td>否</td></tr> <tr><td>slowCallRateThreshold</td> <td>慢请求占比，当慢调用请求数达到该比例触发通断</td> <td>100</td> <td>否</td></tr> <tr><td>waitDurationInOpenState</td> <td>熔断后恢复时间</td> <td>60s</td> <td>否</td></tr></tbody></table> <p>以zookeeper为例，当使用<code>zookeeper</code>配置中心设置熔断规则时，结合上述<code>group</code>和<code>key</code>的说明，需要在<code>zookeeper</code>中创建节点<code>/service=${spring.applicaton.name}/servicecomb.circuitBreaker.${sceneName}</code>,节点内容为熔断规则，如下述yaml内容：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">failureRateThreshold</span><span class="token punctuation">:</span> <span class="token number">90</span>
<span class="token key atrule">minimumNumberOfCalls</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> degrade
<span class="token key atrule">slidingWindowSize</span><span class="token punctuation">:</span> 10S
<span class="token key atrule">slidingWindowType</span><span class="token punctuation">:</span> time
<span class="token key atrule">slowCallDurationThreshold</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span>
<span class="token key atrule">slowCallRateThreshold</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token key atrule">waitDurationInOpenState</span><span class="token punctuation">:</span> 10s
</code></pre></div><p><strong>上述熔断规则解释：</strong> 10秒内，若流量标记的接口请求次数超过3次，且错误率超过90%或者慢请求占比超过80%则触发熔断。</p></li> <li><p><strong>隔离</strong></p> <p><strong>隔离规则配置键前缀:</strong> <code>servicecomb.bulkhead</code></p> <p><strong>隔离规则：</strong></p> <table><thead><tr><th>配置项</th> <th>说明</th> <th>默认值</th> <th>是否必须</th></tr></thead> <tbody><tr><td>maxConcurrentCalls</td> <td>最大并发数</td> <td>1000</td> <td>否</td></tr> <tr><td>maxWaitDuration</td> <td>最大等待时间，若线程超过<code>maxConcurrentCalls</code>，会尝试等待，若超出等待时间还未获取资源，则抛出隔离仓异常</td> <td>0</td> <td>否</td></tr> <tr><td>name</td> <td>可选，配置名称</td> <td>null</td> <td>否</td></tr></tbody></table> <p>以zookeeper为例，当使用<code>zookeeper</code>配置中心设置隔离规则时，结合上述<code>group</code>和<code>key</code>的说明，需要在<code>zookeeper</code>中创建节点<code>/service=${spring.applicaton.name}/servicecomb.circuitBreaker.${sceneName}</code>,节点内容为隔离规则，如下述yaml内容：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">maxConcurrentCalls</span><span class="token punctuation">:</span> <span class="token string">&quot;5&quot;</span>
<span class="token key atrule">maxWaitDuration</span><span class="token punctuation">:</span> <span class="token string">&quot;10S&quot;</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;隔离仓&quot;</span>
</code></pre></div><p><strong>上述隔离规则解释：</strong> 针对流量标记的接口, 若最大并发数超过5，且新的请求等待10S，还未获取资源，则触发隔离仓异常。</p></li> <li><p><strong>重试</strong></p> <p><strong>重试规则配置键前缀:</strong> <code>servicecomb.retry</code></p> <p><strong>重试规则：</strong></p> <table><thead><tr><th>配置项</th> <th>说明</th> <th>默认值</th> <th>是否必须</th></tr></thead> <tbody><tr><td>waitDuration</td> <td>重试等待时间，默认毫秒；支持秒单位，例如2S</td> <td>10ms</td> <td>否</td></tr> <tr><td>retryStrategy</td> <td>重试策略，当前支持两种重试策略：固定时间间隔（FixedInterval）， 指数增长间隔(RandomBackoff)</td> <td>FixedInterval</td> <td>否</td></tr> <tr><td>maxAttempts</td> <td>最大重试次数</td> <td>3</td> <td>否</td></tr> <tr><td>retryOnResponseStatus</td> <td>HTTP状态码，当前仅支持HTTP请求；针对dubbo请求，可通过配置异常类型确定是否需要重试，默认为RpcException</td> <td>null</td> <td>否</td></tr></tbody></table> <p>以zookeeper为例，当使用<code>zookeeper</code>配置中心设置重试规则时，结合上述<code>group</code>和<code>key</code>的说明，需要在<code>zookeeper</code>中创建节点<code>/service=${spring.applicaton.name}/servicecomb.retry.${sceneName}</code>,节点内容为重试规则，如下述yaml内容：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">waitDuration</span><span class="token punctuation">:</span> <span class="token string">&quot;2000&quot;</span>
<span class="token key atrule">retryStrategy</span><span class="token punctuation">:</span> FixedInterval
<span class="token key atrule">maxAttempts</span><span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token key atrule">retryOnResponseStatus</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token number">500</span>
</code></pre></div><p><strong>上述重试规则解释：</strong> 针对流量标记的接口, 当请求抛出500异常时进行重试，直到重试成功或者达到最大重试次数。</p></li> <li><p><strong>错误注入</strong></p> <p><strong>错误注入规则配置键前缀:</strong> <code>servicecomb.faultInjection</code></p> <p><strong>错误注入规则：</strong></p> <table><thead><tr><th>配置项</th> <th>说明</th> <th>默认值</th> <th>是否必须</th></tr></thead> <tbody><tr><td>type</td> <td>错误注入类型, 目前支持abort(请求直接返回)与delay（请求延时）</td> <td>delay</td> <td>否</td></tr> <tr><td>percentage</td> <td>错误注入触发概率</td> <td>-1</td> <td>是</td></tr> <tr><td>fallbackType</td> <td>请求调用返回类型，仅<code>type=abort</code>生效。当前支持两种<code>ReturnNull</code>:直接返回空内容，状态码200；<code>ThrowException</code>: 按照指定错误码返回，关联配置<code>errorCode</code></td> <td>ThrowException</td> <td>否</td></tr> <tr><td>errorCode</td> <td>指定错误码返回, 默认500, 仅在<code>type=abort</code>且<code>fallbackType=ThrowException</code>生效</td> <td>500</td> <td>否</td></tr> <tr><td>forceClosed</td> <td>是否强制关闭错误注入能力, 当为true时，错误注入将不会生效。默认false</td> <td>false</td> <td>否</td></tr></tbody></table> <p>以zookeeper为例，当使用<code>zookeeper</code>配置中心设置错误注入规则时，结合上述<code>group</code>和<code>key</code>的说明，需要在<code>zookeeper</code>中创建节点<code>/service=${spring.applicaton.name}/servicecomb.retry.${sceneName}</code>,节点内容为错误注入规则，如下述yaml内容：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">type</span><span class="token punctuation">:</span> abort
<span class="token key atrule">percentage</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token key atrule">fallbackType</span><span class="token punctuation">:</span> ReturnNull
<span class="token key atrule">forceClosed</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">errorCode</span><span class="token punctuation">:</span> <span class="token number">503</span>
</code></pre></div><p><strong>上述错误注入规则解释：</strong> 当请求流量标记的接口时，100%将返回空。</p></li> <li><p><strong>系统规则</strong></p> <p><strong>系统规则配置键前缀:</strong> <code>servicecomb.system</code></p> <table><thead><tr><th>配置项</th> <th>说明</th> <th>默认值</th> <th>是否必须</th></tr></thead> <tbody><tr><td>systemLoad</td> <td>系统负载阈值，仅支持linux</td> <td>Double.MAX_VALUE</td> <td>否</td></tr> <tr><td>cpuUsage</td> <td>系统cpu使用率阈值</td> <td>1.0</td> <td>否</td></tr> <tr><td>qps</td> <td>入口流量的qps阈值</td> <td>Double.MAX_VALUE</td> <td>否</td></tr> <tr><td>aveRt</td> <td>入口流量的平均响应时间阈值，单位ms</td> <td>Long.MAX_VALUE</td> <td>否</td></tr> <tr><td>threadNum</td> <td>入口流量的并发线程数阈值</td> <td>Long.MAX_VALUE</td> <td>否</td></tr></tbody></table> <p>以zookeeper为例，当使用<code>zookeeper</code>配置中心设置系统规则时，结合上述<code>group</code>和<code>key</code>的说明，需要在<code>zookeeper</code>中创建节点<code>/service=${spring.applicaton.name}/servicecomb.system.${sceneName}</code>,节点内容为系统规则，如下述yaml内容：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">systemLoad</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">cpuUsage</span><span class="token punctuation">:</span> <span class="token number">0.6</span>
<span class="token key atrule">qps</span><span class="token punctuation">:</span> <span class="token number">1000</span>
<span class="token key atrule">aveRt</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token key atrule">threadNum</span><span class="token punctuation">:</span> <span class="token number">200</span>
</code></pre></div><p><strong>上述系统规则解释：</strong></p> <ul><li>针对使用流控插件的应用示例来说，当系统负载超过5，或者cpu使用率超过0.6，或者qps超过1000，或者请求响应时间小鱼100ms，或者并发线程数大于200时，即触发限流，返回对应异常信息。</li> <li>若开启系统自适应开关，则当系统负载大于5时，若当前并发线程数大于系统容量（系统容量由qps * minRt计算得出），则触发限流。</li></ul></li></ul> <h3 id="基于配置文件设置规则"><a href="#基于配置文件设置规则" class="header-anchor">#</a> 基于配置文件设置规则</h3> <p>若应用未采用配置中心的方式配置流控规则，也可采用配置文件的方式使用流控能力。</p> <p>流控插件在应用启动时，会尝试的从SpringBoot加载的配置源读取流控规则以及对应的流量标记，用户需要在启动之前进行配置。如下为配置示例, 示例配置直接基于<code>application.yml</code>进行配置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">servicecomb</span><span class="token punctuation">:</span>                            <span class="token comment"># 流量标记前缀</span>
  <span class="token key atrule">matchGroup</span><span class="token punctuation">:</span>                           <span class="token comment"># 流量标记前缀</span>
    <span class="token key atrule">demo-fault-null</span><span class="token punctuation">:</span>                    <span class="token comment"># 错误注入场景</span>
      <span class="token key atrule">matches</span><span class="token punctuation">:</span>                          <span class="token comment"># 匹配器集合</span>
        <span class="token punctuation">-</span> <span class="token key atrule">apiPath</span><span class="token punctuation">:</span>                      <span class="token comment"># 匹配的api路径</span>
            <span class="token key atrule">exact</span><span class="token punctuation">:</span> <span class="token string">&quot;/flow&quot;</span>              <span class="token comment"># 具体匹配路径</span>
    <span class="token key atrule">demo-retry</span><span class="token punctuation">:</span>                         <span class="token comment"># 重试场景</span>
      <span class="token key atrule">matches</span><span class="token punctuation">:</span>                          
        <span class="token punctuation">-</span> <span class="token key atrule">apiPath</span><span class="token punctuation">:</span>                      
            <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">&quot;/retry&quot;</span>            
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> rest<span class="token punctuation">-</span>provider    
          <span class="token key atrule">method</span><span class="token punctuation">:</span>                       <span class="token comment"># 支持方法类型</span>
          <span class="token punctuation">-</span> GET                         
    <span class="token key atrule">demo-rateLimiting</span><span class="token punctuation">:</span>                  <span class="token comment"># 限流场景</span>
      <span class="token key atrule">matches</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">apiPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">exact</span><span class="token punctuation">:</span> <span class="token string">&quot;/flow&quot;</span>
    <span class="token key atrule">demo-circuitBreaker-exception</span><span class="token punctuation">:</span>      <span class="token comment"># 熔断场景</span>
      <span class="token key atrule">matches</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">apiPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">exact</span><span class="token punctuation">:</span> <span class="token string">&quot;/exceptionBreaker&quot;</span>
    <span class="token key atrule">demo-bulkhead</span><span class="token punctuation">:</span>                      <span class="token comment"># 隔离舱场景</span>
      <span class="token key atrule">matches</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">apiPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">exact</span><span class="token punctuation">:</span> <span class="token string">&quot;/flowcontrol/bulkhead&quot;</span>
    <span class="token key atrule">demo-system</span><span class="token punctuation">:</span>                        <span class="token comment"># 系统规则场景</span>
      <span class="token key atrule">matched</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">apiPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /
  <span class="token key atrule">rateLimiting</span><span class="token punctuation">:</span>                         <span class="token comment"># 限流规则</span>
    <span class="token key atrule">demo-rateLimiting</span><span class="token punctuation">:</span>
      <span class="token key atrule">rate</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">retry</span><span class="token punctuation">:</span>                                <span class="token comment"># 重试规则</span>
    <span class="token key atrule">demo-retry</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      maxAttempts: 3
      retryOnResponseStatus:
      - 500</span>
  <span class="token key atrule">circuitBreaker</span><span class="token punctuation">:</span>                       <span class="token comment"># 熔断规则</span>
    <span class="token key atrule">demo-circuitBreaker-exception</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      failureRateThreshold: 44
      minimumNumberOfCalls: 2
      name: 熔断
      slidingWindowSize: 10000
      slidingWindowType: time
      waitDurationInOpenState: 5s</span>
  <span class="token key atrule">bulkhead</span><span class="token punctuation">:</span>                             <span class="token comment"># 隔离规则</span>
    <span class="token key atrule">demo-bulkhead</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      maxConcurrentCalls: 1
      maxWaitDuration: 10</span>
  <span class="token key atrule">faultInjection</span><span class="token punctuation">:</span>                       <span class="token comment"># 错误注入规则</span>
    <span class="token key atrule">demo-fault-null</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      type: abort
      percentage: 100
      fallbackType: ReturnNull
      forceClosed: false</span>
  <span class="token key atrule">system</span><span class="token punctuation">:</span>                               <span class="token comment"># 系统流控规则</span>
    <span class="token key atrule">demo-system</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      systemLoad: 0.6
      cpuUsage: 0.6
      qps: 100
      aveRt: 20
      threadNum: 100</span>
</code></pre></div><h3 id="基于sermant动态配置中心发布规则"><a href="#基于sermant动态配置中心发布规则" class="header-anchor">#</a> 基于Sermant动态配置中心发布规则</h3> <p>基于Sermant动态配置中心发布规则，可以参考<a href="/zh/document/user-guide/configuration-center.html">动态配置中心使用手册</a>。</p> <h2 id="支持版本与限制"><a href="#支持版本与限制" class="header-anchor">#</a> 支持版本与限制</h2> <h3 id="支持版本"><a href="#支持版本" class="header-anchor">#</a> 支持版本</h3> <table><thead><tr><th>框架类型</th> <th>版本支持</th></tr></thead> <tbody><tr><td>SpringBoot</td> <td>1.2.x - 2.6.x</td></tr> <tr><td>SpringWebMvc</td> <td>4.1.3.RELEASE - 5.3.x</td></tr> <tr><td>Dubbo</td> <td>2.6.x-2.7.x</td></tr></tbody></table> <h3 id="限制"><a href="#限制" class="header-anchor">#</a> 限制</h3> <ul><li>系统规则与系统自适应规则中<code>systemLoad</code>配置仅限于<strong>Linux</strong>。</li> <li>上述<a href="#%E5%9F%BA%E4%BA%8E%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AE%BE%E7%BD%AE%E9%85%8D%E7%BD%AE">基于配置文件设置配置</a> 仅限于<strong>Springboot</strong>应用。</li></ul> <h2 id="操作和结果验证"><a href="#操作和结果验证" class="header-anchor">#</a> 操作和结果验证</h2> <p>下面将演示如何使用流控插件，验证springboot应用采用zookeeper配置中心，设置限流策略场景。</p> <h3 id="准备工作"><a href="#准备工作" class="header-anchor">#</a> 准备工作</h3> <ul><li><a href="https://github.com/huaweicloud/Sermant-examples/tree/main/flowcontrol-demo/spring-cloud-demo/spring-provider" target="_blank" rel="noopener noreferrer">下载<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> demo源码</li> <li><a href="https://github.com/huaweicloud/Sermant/releases" target="_blank" rel="noopener noreferrer">下载<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或编译Sermant包</li> <li><a href="https://zookeeper.apache.org/releases#download" target="_blank" rel="noopener noreferrer">下载<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 并启动zookeeper</li></ul> <h3 id="步骤一-编译打包demo应用"><a href="#步骤一-编译打包demo应用" class="header-anchor">#</a> 步骤一：编译打包demo应用</h3> <p>在<code>${path}/Sermant-examples/flowcontrol-demo/spring-cloud-demo/spring-provider</code>目录执行以下命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># windows,Linux,mac</span>
mvn clean package
</code></pre></div><p>打包成功后，在<code>${path}/Sermant-examples/flowcontrol-demo/spring-cloud-demo/spring-provider/target</code>得到<code>spring-provider.jar</code>。</p> <blockquote><p><strong>说明</strong>： ${path}为demo应用下载所在路径。</p></blockquote> <h3 id="步骤二-修改插件配置"><a href="#步骤二-修改插件配置" class="header-anchor">#</a> 步骤二：修改插件配置</h3> <p>参考<a href="#%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE">插件配置</a> 修改<code>${path}/sermant-agent-x.x.x/agent/pluginPackage/flowcontrol/config/config.yaml</code>文件为以下内容：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>flow.control.plugin:
  useCseRule: <span class="token boolean">false</span> <span class="token comment"># 是否开启ServiceComb适配</span>
  enable-start-monitor: <span class="token boolean">false</span> <span class="token comment"># 是否启动指标监控</span>
  enable-system-adaptive: <span class="token boolean">false</span> <span class="token comment"># 是否开启系统自适应流控</span>
  enable-system-rule: <span class="token boolean">false</span> <span class="token comment"># 是否开启系统规则流控</span>
</code></pre></div><blockquote><p><strong>说明</strong>： ${path}为sermant所在路径。</p></blockquote> <h3 id="步骤三-启动demo应用"><a href="#步骤三-启动demo应用" class="header-anchor">#</a> 步骤三：启动demo应用</h3> <p>参考如下命令启动demo应用</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># windwos</span>
<span class="token function">java</span> -javaagent:<span class="token variable">${path}</span><span class="token punctuation">\</span>sermant-agent-x.x.x<span class="token punctuation">\</span>agent<span class="token punctuation">\</span>sermant-agent.jar <span class="token parameter variable">-Dspring.application.name</span><span class="token operator">=</span>spring-flow-provider <span class="token parameter variable">-Dspring.cloud.zookeeper.connectString</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:2181 <span class="token parameter variable">-jar</span> spring-provider.jar

<span class="token comment">#linux mac</span>
<span class="token function">java</span> -javaagent:<span class="token variable">${path}</span>/sermant-agent-x.x.x/agent/sermant-agent.jar <span class="token parameter variable">-Dspring.application.name</span><span class="token operator">=</span>spring-flow-provider <span class="token parameter variable">-Dspring.cloud.zookeeper.connectString</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1:2181 <span class="token parameter variable">-jar</span> spring-provider.jar
</code></pre></div><blockquote><p><strong>说明：</strong> ${path}为sermant实际安装路径，x.x.x代表sermant某个版本号。</p></blockquote> <h3 id="步骤四-发布流量标记"><a href="#步骤四-发布流量标记" class="header-anchor">#</a> 步骤四：发布流量标记</h3> <p>参考使用<a href="/zh/document/user-guide/configuration-center.html">动态配置中心使用手册</a>，发布如下配置：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;alias: scene\nmatches:\n- apiPath:\n    exact: /flow\n  headers: {}\n  method:\n  - GET\n  name: flow\n&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;group&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service=spring-flow-provider&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;servicecomb.matchGroup.sceneFlow&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>利用zookeeper提供的命令行工具来发布流量标记策略和流控策略：</p> <ol><li>在<code>${path}/bin/</code>目录执行以下命令创建节点<code>/service=spring-flow-provider</code></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># linux mac</span>
./zkCli.sh <span class="token parameter variable">-server</span> localhost:2181 create /service<span class="token operator">=</span>spring-flow-provider

<span class="token comment"># windows</span>
zkCli.cmd <span class="token parameter variable">-server</span> localhost:2181 create /service<span class="token operator">=</span>spring-flow-provider
</code></pre></div><ol start="2"><li>在<code>${path}/bin/</code>目录执行以下命令创建节点<code>/service=spring-flow-provider/servicecomb.matchGroup.sceneFlow</code>和数据<code>&quot;alias: scene\nmatches:\n- apiPath:\n exact: /flow\n headers: {}\n method:\n - GET\n name: flow\n&quot;</code></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># linux mac</span>
./zkCli.sh <span class="token parameter variable">-server</span> localhost:2181 create /service<span class="token operator">=</span>spring-flow-provider/servicecomb.matchGroup.sceneFlow <span class="token string">&quot;alias: scene
matches:
- apiPath:
    exact: /flow
  headers: {}
  method:
  - GET
  name: flow&quot;</span>
  
<span class="token comment"># windwos</span>
zkCli.cmd <span class="token parameter variable">-server</span> localhost:2181 create /service<span class="token operator">=</span>spring-flow-provider/servicecomb.matchGroup.sceneFlow <span class="token string">&quot;alias: scene
matches:
- apiPath:
    exact: /flow
  headers: {}
  method:
  - GET
  name: flow&quot;</span>
</code></pre></div><ol start="3"><li>在<code>${path}/bin/</code>目录执行以下命令创建节点<code>/service=spring-flow-provider/servicecomb.rateLimiting.sceneFlow</code>和数据<code>&quot;limitRefreshPeriod: \&quot;2S\&quot;\nname: flow\nrate: \&quot;4\&quot;\n&quot;</code></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># linux mac</span>
./zkCli.sh <span class="token parameter variable">-server</span> localhost:2181 create /service<span class="token operator">=</span>spring-flow-provider/servicecomb.rateLimiting.sceneFlow <span class="token string">&quot;limitRefreshPeriod: 2S
name: flow
rate: 4&quot;</span>

<span class="token comment">#windows</span>
zkCli.cmd <span class="token parameter variable">-server</span> localhost:2181 create /service<span class="token operator">=</span>spring-flow-provider/servicecomb.rateLimiting.sceneFlow <span class="token string">&quot;limitRefreshPeriod: 2S
name: flow
rate: 4&quot;</span>
</code></pre></div><blockquote><p>说明：${path}为zookeeper的安装目录。</p></blockquote> <h3 id="验证"><a href="#验证" class="header-anchor">#</a> 验证</h3> <p>通过curl工具多次请求<code>localhost:8003/flow</code>, 若在2秒内请求数超过4个时返回<code>rate limited</code>，则触发流控成功，效果如下：</p> <div class="el-image"><div class="el-image__placeholder"></div><!----></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/5/18 03:18:50</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/zh/document/plugin/dynamic-config.html" class="prev">
        动态配置
      </a></span> <span class="next"><a href="/zh/document/plugin/graceful.html">
        无损上下线
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.56245a25.js" defer></script><script src="/assets/js/3.c22b673d.js" defer></script><script src="/assets/js/1.9e8b067b.js" defer></script><script src="/assets/js/75.7fb65875.js" defer></script><script src="/assets/js/14.7039f4a7.js" defer></script>
  </body>
</html>
